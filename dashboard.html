<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KFA 축구 데이터 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .nav-tabs .nav-link {
            color: #495057;
            border: none;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link:hover {
            background-color: #e9ecef;
            color: #495057;
        }
        
        .nav-tabs .nav-link.active {
            background-color: #667eea;
            color: white;
            border: none;
        }
        
        .standings-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        .standings-card:hover {
            transform: translateY(-5px);
        }
        
        .standings-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: bold;
        }
        
        .standings-table {
            margin: 0;
        }
        
        .standings-table th {
            background-color: #f8f9fa;
            border: none;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.75rem 0.5rem;
        }
        
        .standings-table td {
            border: none;
            padding: 0.75rem 0.5rem;
            vertical-align: middle;
        }
        
        .standings-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .position-badge {
            display: inline-block;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background-color: #6c757d;
            color: white;
            text-align: center;
            line-height: 25px;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .position-1 { background-color: #ffd700; color: #333; }
        .position-2 { background-color: #c0c0c0; color: #333; }
        .position-3 { background-color: #cd7f32; color: white; }
        
        .team-region-badge {
            background-color: #e9ecef;
            color: #495057;
            padding: 0.2rem 0.5rem;
            border-radius: 15px;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
        
        .match-status-completed {
            background-color: #28a745;
            color: white;
        }
        
        .match-status-upcoming {
            background-color: #ffc107;
            color: #333;
        }
        
        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-custom {
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-3px);
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .table-responsive {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .table {
            margin: 0;
            background: white;
        }
        
        .table th {
            background-color: #667eea;
            color: white;
            border: none;
            font-weight: 600;
            padding: 1rem 0.75rem;
        }
        
        .table td {
            border: none;
            padding: 0.75rem;
            vertical-align: middle;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0"><i class="fas fa-futbol me-3"></i>KFA 축구 데이터 대시보드</h1>
                    <p class="mb-0 mt-2">실시간 리그 순위표 및 경기 기록 관리</p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/" class="btn btn-light btn-custom me-2">
                        <i class="fas fa-spider me-2"></i>크롤링 대시보드
                    </a>
                    <a href="/dashboard" class="btn btn-outline-light btn-custom">
                        <i class="fas fa-chart-line me-2"></i>데이터 대시보드
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- 탭 네비게이션 -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="standings-tab" data-bs-toggle="tab" data-bs-target="#standings" type="button" role="tab">
                    <i class="fas fa-trophy me-2"></i>리그 순위표
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="matches-tab" data-bs-toggle="tab" data-bs-target="#matches" type="button" role="tab">
                    <i class="fas fa-calendar-alt me-2"></i>경기 기록 & 일정
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                    <i class="fas fa-chart-bar me-2"></i>통계 분석
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="management-tab" data-bs-toggle="tab" data-bs-target="#management" type="button" role="tab">
                    <i class="fas fa-cogs me-2"></i>데이터 관리
                </button>
            </li>
        </ul>

        <!-- 탭 컨텐츠 -->
        <div class="tab-content" id="mainTabContent">
            <!-- 리그 순위표 탭 -->
            <div class="tab-pane fade show active" id="standings" role="tabpanel">
                <div class="filter-section">
                    <div class="row align-items-end">
                        <div class="col-md-3">
                            <label for="regionFilter" class="form-label">지역 선택</label>
                            <select class="form-select" id="regionFilter">
                                <option value="">전체 지역</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="leagueFilter" class="form-label">리그 선택</label>
                            <select class="form-select" id="leagueFilter">
                                <option value="">전체 리그</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary-custom btn-custom" onclick="loadStandings()">
                                <i class="fas fa-sync-alt me-2"></i>순위표 새로고침
                            </button>
                        </div>
                        <div class="col-md-3 text-end">
                            <div class="stats-card d-inline-block">
                                <div class="stats-number" id="totalLeagues">0</div>
                                <div class="text-muted">총 리그 수</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="standingsContainer" class="row">
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">로딩 중...</span>
                        </div>
                        <p class="mt-3 text-muted">순위표를 불러오는 중입니다...</p>
                    </div>
                </div>
            </div>

            <!-- 경기 기록 & 일정 탭 -->
            <div class="tab-pane fade" id="matches" role="tabpanel">
                <div class="filter-section">
                    <div class="row align-items-end">
                        <div class="col-md-2">
                            <label for="matchRegionFilter" class="form-label">지역</label>
                            <select class="form-select" id="matchRegionFilter">
                                <option value="">전체</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="matchLeagueFilter" class="form-label">리그</label>
                            <select class="form-select" id="matchLeagueFilter">
                                <option value="">전체</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="matchTeamFilter" class="form-label">팀</label>
                            <select class="form-select" id="matchTeamFilter">
                                <option value="">전체</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="matchStatusFilter" class="form-label">상태</label>
                            <select class="form-select" id="matchStatusFilter">
                                <option value="">전체</option>
                                <option value="완료">완료</option>
                                <option value="예정">예정</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary-custom btn-custom" onclick="loadMatches()">
                                <i class="fas fa-search me-2"></i>검색
                            </button>
                        </div>
                        <div class="col-md-2 text-end">
                            <div class="stats-card d-inline-block">
                                <div class="stats-number" id="totalMatches">0</div>
                                <div class="text-muted">총 경기 수</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table" id="matchesTable">
                        <thead>
                            <tr>
                                <th>날짜</th>
                                <th>시간</th>
                                <th>리그</th>
                                <th>홈팀</th>
                                <th>결과</th>
                                <th>어웨이팀</th>
                                <th>경기장</th>
                                <th>상태</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="matchesTableBody">
                            <tr>
                                <td colspan="9" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">로딩 중...</span>
                                    </div>
                                    <p class="mt-3 text-muted">경기 데이터를 불러오는 중입니다...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 통계 분석 탭 -->
            <div class="tab-pane fade" id="analytics" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="avgGoals">0</div>
                            <div class="text-muted">경기당 평균 득점</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="highestScore">0</div>
                            <div class="text-muted">최고 득점</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="mostActiveLeague">-</div>
                            <div class="text-muted">가장 활발한 리그</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="recentActivity">-</div>
                            <div class="text-muted">최근 업데이트</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 데이터 관리 탭 -->
            <div class="tab-pane fade" id="management" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="stats-card">
                            <h5>경기 데이터 관리</h5>
                            <p class="text-muted">경기 정보 수정 및 삭제</p>
                            <button class="btn btn-primary-custom btn-custom" onclick="refreshAllData()">
                                <i class="fas fa-sync-alt me-2"></i>전체 데이터 새로고침
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stats-card">
                            <h5>리그 정보 관리</h5>
                            <p class="text-muted">리그 설정 및 구성 관리</p>
                            <button class="btn btn-outline-primary btn-custom" onclick="exportData()">
                                <i class="fas fa-download me-2"></i>데이터 내보내기
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 전역 변수
        let allStandings = [];
        let allMatches = [];
        let regions = [];
        let leagues = {};

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadRegions();
            loadStandings();
            loadMatches();
            loadAnalytics();
        });

        // 지역 목록 로드
        async function loadRegions() {
            try {
                const response = await fetch('/api/regions');
                regions = await response.json();
                
                const regionSelects = ['regionFilter', 'matchRegionFilter'];
                regionSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">전체 지역</option>';
                    regions.forEach(region => {
                        select.innerHTML += `<option value="${region}">${region}</option>`;
                    });
                });

                // 지역 선택 이벤트 리스너
                document.getElementById('regionFilter').addEventListener('change', onRegionChange);
                document.getElementById('matchRegionFilter').addEventListener('change', onMatchRegionChange);
            } catch (error) {
                console.error('지역 목록 로드 실패:', error);
            }
        }

        // 지역 변경 시 리그 목록 업데이트
        async function onRegionChange() {
            const region = document.getElementById('regionFilter').value;
            await loadLeaguesForRegion(region, 'leagueFilter');
        }

        async function onMatchRegionChange() {
            const region = document.getElementById('matchRegionFilter').value;
            await loadLeaguesForRegion(region, 'matchLeagueFilter');
            loadTeamsForFilters();
        }

        // 특정 지역의 리그 목록 로드
        async function loadLeaguesForRegion(region, selectId) {
            try {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">전체 리그</option>';
                
                if (!region) return;

                const response = await fetch(`/api/leagues/${encodeURIComponent(region)}`);
                const regionLeagues = await response.json();
                
                regionLeagues.forEach(league => {
                    select.innerHTML += `<option value="${league}">${league}</option>`;
                });
            } catch (error) {
                console.error('리그 목록 로드 실패:', error);
            }
        }

        // 팀 목록 로드 (필터용)
        function loadTeamsForFilters() {
            const region = document.getElementById('matchRegionFilter').value;
            const league = document.getElementById('matchLeagueFilter').value;
            
            const teamSelect = document.getElementById('matchTeamFilter');
            teamSelect.innerHTML = '<option value="">전체 팀</option>';
            
            const teams = new Set();
            allMatches.forEach(match => {
                if ((!region || match.regionTag === region) && 
                    (!league || match.leagueTitle === league)) {
                    if (match.HOME_TEAM_NAME) teams.add(match.HOME_TEAM_NAME);
                    if (match.AWAY_TEAM_NAME) teams.add(match.AWAY_TEAM_NAME);
                }
            });
            
            Array.from(teams).sort().forEach(team => {
                teamSelect.innerHTML += `<option value="${team}">${team}</option>`;
            });
        }

        // 순위표 로드
        async function loadStandings() {
            try {
                const response = await fetch('/api/standings');
                allStandings = await response.json();
                
                document.getElementById('totalLeagues').textContent = allStandings.length;
                renderStandings();
            } catch (error) {
                console.error('순위표 로드 실패:', error);
                document.getElementById('standingsContainer').innerHTML = 
                    '<div class="col-12 text-center py-5"><p class="text-danger">순위표를 불러오는데 실패했습니다.</p></div>';
            }
        }

        // 순위표 렌더링
        function renderStandings() {
            const region = document.getElementById('regionFilter').value;
            const league = document.getElementById('leagueFilter').value;
            
            let filteredStandings = allStandings;
            if (region) filteredStandings = filteredStandings.filter(s => s.region === region);
            if (league) filteredStandings = filteredStandings.filter(s => s.league === league);
            
            const container = document.getElementById('standingsContainer');
            
            if (filteredStandings.length === 0) {
                container.innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted">표시할 순위표가 없습니다.</p></div>';
                return;
            }
            
            container.innerHTML = '';
            
            filteredStandings.forEach(standingData => {
                const colClass = filteredStandings.length === 1 ? 'col-12' : 
                                filteredStandings.length <= 2 ? 'col-md-6' : 'col-lg-4 col-md-6';
                
                const card = document.createElement('div');
                card.className = colClass;
                card.innerHTML = `
                    <div class="standings-card">
                        <div class="standings-header">
                            <h5 class="mb-0">${standingData.region} ${standingData.league}</h5>
                        </div>
                        <table class="table standings-table">
                            <thead>
                                <tr>
                                    <th>순위</th>
                                    <th>팀명</th>
                                    <th>경기</th>
                                    <th>승</th>
                                    <th>무</th>
                                    <th>패</th>
                                    <th>득점</th>
                                    <th>실점</th>
                                    <th>골득실</th>
                                    <th>승점</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${standingData.standings.map((team, index) => `
                                    <tr>
                                        <td>
                                            <span class="position-badge ${index < 3 ? 'position-' + (index + 1) : ''}">${index + 1}</span>
                                        </td>
                                        <td>
                                            <strong>${team.teamName}</strong>
                                        </td>
                                        <td>${team.played}</td>
                                        <td class="text-success">${team.won}</td>
                                        <td class="text-warning">${team.drawn}</td>
                                        <td class="text-danger">${team.lost}</td>
                                        <td>${team.goalsFor}</td>
                                        <td>${team.goalsAgainst}</td>
                                        <td class="${team.goalDifference >= 0 ? 'text-success' : 'text-danger'}">${team.goalDifference > 0 ? '+' : ''}${team.goalDifference}</td>
                                        <td><strong>${team.points}</strong></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 경기 목록 로드
        async function loadMatches() {
            try {
                const response = await fetch('/api/matches');
                allMatches = await response.json();
                
                document.getElementById('totalMatches').textContent = allMatches.length;
                loadTeamsForFilters();
                renderMatches();
            } catch (error) {
                console.error('경기 목록 로드 실패:', error);
            }
        }

        // 경기 목록 렌더링
        function renderMatches() {
            const region = document.getElementById('matchRegionFilter').value;
            const league = document.getElementById('matchLeagueFilter').value;
            const team = document.getElementById('matchTeamFilter').value;
            const status = document.getElementById('matchStatusFilter').value;
            
            let filteredMatches = allMatches.filter(match => {
                return (!region || match.regionTag === region) &&
                       (!league || match.leagueTitle === league) &&
                       (!team || match.HOME_TEAM_NAME === team || match.AWAY_TEAM_NAME === team) &&
                       (!status || match.MATCH_STATUS === status);
            });
            
            const tbody = document.getElementById('matchesTableBody');
            
            if (filteredMatches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-5">조건에 맞는 경기가 없습니다.</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredMatches.map(match => `
                <tr>
                    <td>${match.MATCH_DATE || '-'}</td>
                    <td>${match.MATCH_TIME_FORMATTED || '-'}</td>
                    <td><small class="text-muted">${match.leagueTitle || '-'}</small></td>
                    <td>
                        ${match.HOME_TEAM_REGION ? `<span class="team-region-badge">${match.HOME_TEAM_REGION}</span>` : ''}
                        <strong>${match.HOME_TEAM_NAME || match.TH_CLUB_NAME}</strong>
                    </td>
                    <td class="text-center">
                        ${match.MATCH_STATUS === '완료' ? 
                            `<strong>${match.TH_SCORE_FINAL || 0} : ${match.TA_SCORE_FINAL || 0}</strong>` : 
                            '<span class="text-muted">vs</span>'
                        }
                    </td>
                    <td>
                        ${match.AWAY_TEAM_REGION ? `<span class="team-region-badge">${match.AWAY_TEAM_REGION}</span>` : ''}
                        <strong>${match.AWAY_TEAM_NAME || match.TA_CLUB_NAME}</strong>
                    </td>
                    <td><small class="text-muted">${match.STADIUM || '-'}</small></td>
                    <td>
                        <span class="badge ${match.MATCH_STATUS === '완료' ? 'match-status-completed' : 'match-status-upcoming'}">
                            ${match.MATCH_STATUS || '예정'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editMatch('${match.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteMatch('${match.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 통계 분석 로드
        async function loadAnalytics() {
            try {
                const response = await fetch('/api/analytics');
                const analytics = await response.json();
                
                document.getElementById('avgGoals').textContent = analytics.avgGoals;
                document.getElementById('highestScore').textContent = analytics.highestScore;
                document.getElementById('mostActiveLeague').textContent = analytics.mostActiveLeague;
                document.getElementById('recentActivity').textContent = analytics.recentActivity;
            } catch (error) {
                console.error('통계 로드 실패:', error);
            }
        }

        // 경기 수정
        function editMatch(matchId) {
            // 경기 수정 모달 또는 페이지로 이동
            alert('경기 수정 기능 (구현 예정): ' + matchId);
        }

        // 경기 삭제
        async function deleteMatch(matchId) {
            if (!confirm('정말로 이 경기를 삭제하시겠습니까?')) return;
            
            try {
                const response = await fetch(`/api/matches/${matchId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('경기가 삭제되었습니다.');
                    loadMatches();
                    loadStandings();
                } else {
                    alert('경기 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('경기 삭제 실패:', error);
                alert('경기 삭제 중 오류가 발생했습니다.');
            }
        }

        // 전체 데이터 새로고침
        function refreshAllData() {
            loadStandings();
            loadMatches();
            loadAnalytics();
            alert('모든 데이터가 새로고침되었습니다.');
        }

        // 데이터 내보내기
        function exportData() {
            alert('데이터 내보내기 기능 (구현 예정)');
        }

        // 필터 변경 이벤트 리스너
        document.getElementById('leagueFilter').addEventListener('change', renderStandings);
        document.getElementById('matchLeagueFilter').addEventListener('change', () => {
            loadTeamsForFilters();
            renderMatches();
        });
        document.getElementById('matchTeamFilter').addEventListener('change', renderMatches);
        document.getElementById('matchStatusFilter').addEventListener('change', renderMatches);
    </script>
</body>
</html> 