<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KFA Crawler Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            color: #1877f2;
        }
        .container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 80%;
            max-width: 800px;
        }
        .buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: #fff;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        button:active:not(:disabled) {
            transform: scale(0.98);
        }
        #crawlBtn { background-color: #42b72a; }
        #crawlBtn:hover:not(:disabled) { background-color: #36a420; }
        #uploadBtn { background-color: #1877f2; }
        #uploadBtn:hover:not(:disabled) { background-color: #166fe5; }
        #stopBtn { 
            background-color: #dc3545; 
            display: none;
        }
        #stopBtn:hover:not(:disabled) { background-color: #c82333; }
        
        #logContainer {
            background-color: #000;
            color: #fff;
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            padding: 15px;
            border-radius: 6px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 20px;
        }
        .section {
            margin-top: 25px;
        }
        .section h2 {
            font-size: 18px;
            color: #1c1e21;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        textarea {
            width: 100%;
            box-sizing: border-box;
            height: 150px;
            border: 1px solid #ccd0d5;
            border-radius: 6px;
            padding: 10px;
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 13px;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .control-grid input {
            padding: 10px;
            border: 1px solid #ccd0d5;
            border-radius: 6px;
            font-size: 14px;
        }
        #saveCsvBtn {
            background-color: #6c757d;
            margin-top: 10px;
        }
         #saveCsvBtn:hover:not(:disabled) {
            background-color: #5a6268;
        }
        #copyFiltersBtn:hover:not(:disabled) {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>KFA 크롤러 대시보드</h1>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="/crawler-dashboard" style="display: inline-block; padding: 12px 25px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; text-decoration: none; border-radius: 8px; font-weight: bold; transition: all 0.3s ease;">
                🚀 새로운 크롤러 버전 선택 대시보드 (추천!)
            </a>
        </div>
        
        <div class="section">
            <h2>리그 목록 (leagues.csv) <span id="firebaseStatus" style="font-size: 12px; color: #28a745;">🔥 Firebase 연동</span></h2>
            <textarea id="csvEditor" placeholder="CSV 데이터를 로딩 중입니다..."></textarea>
            <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
                <button id="saveCsvBtn">Firebase에 저장</button>
                <button id="refreshCsvBtn" style="background-color: #17a2b8;">🔄 새로고침</button>
                <div id="csvSyncStatus" style="font-size: 12px; color: #666; margin-left: 10px;">
                    💡 이제 웹에서 직접 편집하고 저장할 수 있습니다!
                </div>
            </div>
        </div>

        <div class="section">
            <h2>크롤링 실행</h2>
            <div class="control-grid">
                <input type="text" id="yearFilter" placeholder="특정 년도 (e.g., 2025)">
                <input type="text" id="monthFilter" placeholder="특정 월 (e.g., 05)">
                <input type="text" id="leagueFilter" placeholder="리그명 일부 검색">
            </div>
            <div class="buttons" style="margin-top: 15px;">
                <button id="crawlBtn">1. 데이터 크롤링 시작</button>
                <button id="stopBtn">🛑 크롤링 중단</button>
            </div>
        </div>

        <div class="section">
            <h2>Firebase 업로드</h2>
            <div class="control-grid">
                <input type="text" id="uploadYearFilter" placeholder="특정 년도 (e.g., 2025)">
                <input type="text" id="uploadMonthFilter" placeholder="특정 월 (e.g., 05)">
                <input type="text" id="uploadLeagueFilter" placeholder="리그명 일부 검색">
            </div>
                         <div class="buttons" style="margin-top: 15px;">
                 <button id="uploadBtn">2. Firestore에 업로드</button>
                 <button id="stopUploadBtn" style="background-color: #dc3545; display: none;">🛑 업로드 중단</button>
                 <button id="copyFiltersBtn" style="background-color: #6c757d;">크롤링 필터 복사</button>
             </div>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                💡 팁: 필터를 비워두면 모든 데이터를 업로드합니다. "크롤링 필터 복사" 버튼으로 위의 크롤링 조건을 쉽게 복사할 수 있습니다.
            </p>
        </div>
        
        <div id="logContainer">작업 로그가 여기에 표시됩니다...</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const crawlBtn = document.getElementById('crawlBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const stopBtn = document.getElementById('stopBtn');
        const stopUploadBtn = document.getElementById('stopUploadBtn');
        const logContainer = document.getElementById('logContainer');
        const csvEditor = document.getElementById('csvEditor');
        const saveCsvBtn = document.getElementById('saveCsvBtn');
        const refreshCsvBtn = document.getElementById('refreshCsvBtn');
        
        // 실행 중인 프로세스 추적
        let currentProcesses = new Map();

        const yearFilter = document.getElementById('yearFilter');
        const monthFilter = document.getElementById('monthFilter');
        const leagueFilter = document.getElementById('leagueFilter');
        
        const uploadYearFilter = document.getElementById('uploadYearFilter');
        const uploadMonthFilter = document.getElementById('uploadMonthFilter');
        const uploadLeagueFilter = document.getElementById('uploadLeagueFilter');
        const copyFiltersBtn = document.getElementById('copyFiltersBtn');

        // CSV 파일을 새로고침하는 함수
        async function refreshCsvContent() {
            try {
                console.log('🔄 CSV 파일 새로고침 중...');
                const firebaseStatus = document.getElementById('firebaseStatus');
                const csvSyncStatus = document.getElementById('csvSyncStatus');
                
                firebaseStatus.textContent = '🔄 로딩 중...';
                firebaseStatus.style.color = '#ffc107';
                
                const response = await fetch('/leagues-csv?' + new Date().getTime()); // 캐시 방지
                if (response.ok) {
                    const content = await response.text();
                    csvEditor.value = content;
                    console.log('✅ CSV 파일 새로고침 완료');
                    console.log('📄 현재 CSV 내용:', content);
                    
                    // Firebase 연동 상태 업데이트
                    firebaseStatus.textContent = '🔥 Firebase 연동';
                    firebaseStatus.style.color = '#28a745';
                    csvSyncStatus.textContent = '✅ Firebase에서 최신 데이터를 불러왔습니다!';
                    csvSyncStatus.style.color = '#28a745';
                    
                    // 3초 후 기본 메시지로 복원
                    setTimeout(() => {
                        csvSyncStatus.textContent = '💡 이제 웹에서 직접 편집하고 저장할 수 있습니다!';
                        csvSyncStatus.style.color = '#666';
                    }, 3000);
                } else {
                    appendLog('❌ leagues.csv 파일을 불러오는 데 실패했습니다.');
                    firebaseStatus.textContent = '❌ 연결 실패';
                    firebaseStatus.style.color = '#dc3545';
                }
            } catch (error) {
                appendLog(`❌ CSV 로딩 중 오류 발생: ${error.message}`);
                const firebaseStatus = document.getElementById('firebaseStatus');
                firebaseStatus.textContent = '❌ 연결 실패';
                firebaseStatus.style.color = '#dc3545';
            }
        }

        // 페이지 로드 시 CSV 데이터 불러오기
        window.addEventListener('load', refreshCsvContent);

        // CSV 저장 버튼 이벤트
        saveCsvBtn.addEventListener('click', async () => {
            try {
                saveCsvBtn.disabled = true;
                saveCsvBtn.textContent = 'Firebase에 저장 중...';
                
                const firebaseStatus = document.getElementById('firebaseStatus');
                const csvSyncStatus = document.getElementById('csvSyncStatus');
                
                firebaseStatus.textContent = '🔄 저장 중...';
                firebaseStatus.style.color = '#ffc107';
                
                const content = csvEditor.value;
                console.log('클라이언트에서 전송할 CSV 내용 길이:', content.length);
                console.log('CSV 내용 미리보기:', content.substring(0, 100));
                
                const response = await fetch('/leagues-csv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content })
                });

                if (response.ok) {
                    const responseText = await response.text();
                    appendLog('✅ CSV 파일이 Firebase에 성공적으로 저장되었습니다.');
                    console.log('서버 응답:', responseText);
                    
                    // 저장 성공 시 상태 업데이트
                    firebaseStatus.textContent = '🔥 Firebase 연동';
                    firebaseStatus.style.color = '#28a745';
                    saveCsvBtn.style.backgroundColor = '#28a745';
                    saveCsvBtn.textContent = 'Firebase에 저장 완료!';
                    saveCsvBtn.disabled = false; // 즉시 버튼 활성화
                    csvSyncStatus.textContent = '✅ Firebase에 성공적으로 저장되었습니다!';
                    csvSyncStatus.style.color = '#28a745';
                    
                    // 3초 후 기본 상태로 복원
                    setTimeout(() => {
                        saveCsvBtn.style.backgroundColor = '#6c757d';
                        saveCsvBtn.textContent = 'Firebase에 저장';
                        saveCsvBtn.disabled = false; // 버튼 활성화 보장
                        csvSyncStatus.textContent = '💡 이제 웹에서 직접 편집하고 저장할 수 있습니다!';
                        csvSyncStatus.style.color = '#666';
                    }, 3000);
                } else {
                    const errorText = await response.text();
                    appendLog(`❌ CSV 파일 저장에 실패했습니다: ${errorText}`);
                    console.error('서버 오류:', errorText);
                    
                    firebaseStatus.textContent = '❌ 저장 실패';
                    firebaseStatus.style.color = '#dc3545';
                    
                    // 오류 시에도 버튼 활성화
                    saveCsvBtn.disabled = false;
                    saveCsvBtn.textContent = 'Firebase에 저장';
                    saveCsvBtn.style.backgroundColor = '#6c757d';
                }
            } catch (error) {
                appendLog(`❌ CSV 저장 중 오류 발생: ${error.message}`);
                console.error('CSV 저장 오류:', error);
                
                const firebaseStatus = document.getElementById('firebaseStatus');
                firebaseStatus.textContent = '❌ 저장 실패';
                firebaseStatus.style.color = '#dc3545';
                
                // 예외 발생 시에도 버튼 활성화
                saveCsvBtn.disabled = false;
                saveCsvBtn.textContent = 'Firebase에 저장';
                saveCsvBtn.style.backgroundColor = '#6c757d';
            } finally {
                // finally 블록에서 확실히 버튼 활성화
                if (saveCsvBtn.textContent.includes('저장 중')) {
                    saveCsvBtn.disabled = false;
                    saveCsvBtn.textContent = 'Firebase에 저장';
                    saveCsvBtn.style.backgroundColor = '#6c757d';
                }
            }
        });

        function disableButtons() {
            crawlBtn.disabled = true;
            uploadBtn.disabled = true;
        }

        function enableButtons() {
            crawlBtn.disabled = false;
            uploadBtn.disabled = false;
            stopBtn.style.display = 'none';
            stopUploadBtn.style.display = 'none';
        }

        function showStopButton(processType) {
            if (processType === 'crawling') {
                stopBtn.style.display = 'inline-block';
            } else if (processType === 'uploading') {
                stopUploadBtn.style.display = 'inline-block';
            }
        }

        function hideStopButton(processType) {
            if (processType === 'crawling') {
                stopBtn.style.display = 'none';
            } else if (processType === 'uploading') {
                stopUploadBtn.style.display = 'none';
            }
        }

        function appendLog(message) {
            // ANSI 이스케이프 시퀀스(컬러 코드)를 제거하는 정규식
            const cleanMessage = message.replace(/[\u001b\u009b][[()#;?]*.?[0-9]{1,4}(?:;[0-9]{0,4})*.?[0-9A-ORZcf-nqry=><]/g, '');
            logContainer.innerHTML += cleanMessage.replace(/\n/g, '<br>');
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        socket.on('connect', () => {
            logContainer.innerHTML = '✅ 서버에 연결되었습니다.<br>';
        });

        socket.on('log', (message) => {
            if (message.includes('프로세스가 종료되었습니다')) {
                enableButtons();
            }
            appendLog(message);
        });

        // 프로세스 시작 이벤트
        socket.on('process-started', (data) => {
            const { processId, type } = data;
            currentProcesses.set(processId, type);
            showStopButton(type);
            console.log(`프로세스 시작: ${processId} (${type})`);
        });

        // 프로세스 종료 이벤트
        socket.on('process-ended', (data) => {
            const { processId, type } = data;
            currentProcesses.delete(processId);
            hideStopButton(type);
            enableButtons();
            console.log(`프로세스 종료: ${processId} (${type})`);
        });

        crawlBtn.addEventListener('click', () => {
            logContainer.innerHTML = '';
            disableButtons();
            
            const options = {
                year: yearFilter.value.trim(),
                month: monthFilter.value.trim(),
                league: leagueFilter.value.trim()
            };

            socket.emit('start-crawling', options);
        });

        uploadBtn.addEventListener('click', () => {
            logContainer.innerHTML = '';
            disableButtons();
            
            const uploadOptions = {
                year: uploadYearFilter.value.trim(),
                month: uploadMonthFilter.value.trim(),
                league: uploadLeagueFilter.value.trim()
            };

            socket.emit('start-uploading', uploadOptions);
        });

        // 크롤링 필터 복사 버튼 이벤트
        copyFiltersBtn.addEventListener('click', () => {
            uploadYearFilter.value = yearFilter.value;
            uploadMonthFilter.value = monthFilter.value;
            uploadLeagueFilter.value = leagueFilter.value;
            
            // 시각적 피드백
            copyFiltersBtn.textContent = '복사 완료!';
            copyFiltersBtn.style.backgroundColor = '#28a745';
            setTimeout(() => {
                copyFiltersBtn.textContent = '크롤링 필터 복사';
                                 copyFiltersBtn.style.backgroundColor = '#6c757d';
             }, 1000);
         });

         // 크롤링 중단 버튼 이벤트
         stopBtn.addEventListener('click', () => {
             const crawlingProcess = Array.from(currentProcesses.entries()).find(([id, type]) => type === 'crawling');
             if (crawlingProcess) {
                 const [processId] = crawlingProcess;
                 socket.emit('stop-process', { processId });
                 stopBtn.disabled = true;
                 stopBtn.textContent = '중단 중...';
                 
                 // 5초 후 버튼 복원 (안전장치)
                 setTimeout(() => {
                     stopBtn.disabled = false;
                     stopBtn.textContent = '🛑 크롤링 중단';
                                   }, 5000);
              }
          });

          // CSV 새로고침 버튼 이벤트
          refreshCsvBtn.addEventListener('click', async () => {
              refreshCsvBtn.disabled = true;
              refreshCsvBtn.textContent = '새로고침 중...';
              
              try {
                  await refreshCsvContent();
                  appendLog('✅ CSV 파일이 새로고침되었습니다.');
              } catch (error) {
                  appendLog(`❌ CSV 새로고침 실패: ${error.message}`);
              } finally {
                  refreshCsvBtn.disabled = false;
                  refreshCsvBtn.textContent = '🔄 새로고침';
              }
          });

         // 업로드 중단 버튼 이벤트
         stopUploadBtn.addEventListener('click', () => {
             const uploadingProcess = Array.from(currentProcesses.entries()).find(([id, type]) => type === 'uploading');
             if (uploadingProcess) {
                 const [processId] = uploadingProcess;
                 socket.emit('stop-process', { processId });
                 stopUploadBtn.disabled = true;
                 stopUploadBtn.textContent = '중단 중...';
                 
                 // 5초 후 버튼 복원 (안전장치)
                 setTimeout(() => {
                     stopUploadBtn.disabled = false;
                     stopUploadBtn.textContent = '🛑 업로드 중단';
                 }, 5000);
             }
         });
    </script>
</body>
</html> 