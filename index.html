<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KFA Crawler Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            color: #1877f2;
        }
        .container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 80%;
            max-width: 800px;
        }
        .buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: #fff;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        button:active:not(:disabled) {
            transform: scale(0.98);
        }
        #crawlBtn { background-color: #42b72a; }
        #crawlBtn:hover:not(:disabled) { background-color: #36a420; }
        #uploadBtn { background-color: #1877f2; }
        #uploadBtn:hover:not(:disabled) { background-color: #166fe5; }
        #stopBtn { 
            background-color: #dc3545; 
            display: none;
        }
        #stopBtn:hover:not(:disabled) { background-color: #c82333; }
        
        #logContainer {
            background-color: #000;
            color: #fff;
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            padding: 15px;
            border-radius: 6px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 20px;
        }
        .section {
            margin-top: 25px;
        }
        .section h2 {
            font-size: 18px;
            color: #1c1e21;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        textarea {
            width: 100%;
            box-sizing: border-box;
            height: 150px;
            border: 1px solid #ccd0d5;
            border-radius: 6px;
            padding: 10px;
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 13px;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .control-grid input {
            padding: 10px;
            border: 1px solid #ccd0d5;
            border-radius: 6px;
            font-size: 14px;
        }
        #saveCsvBtn {
            background-color: #6c757d;
            margin-top: 10px;
        }
         #saveCsvBtn:hover:not(:disabled) {
            background-color: #5a6268;
        }
        #copyFiltersBtn:hover:not(:disabled) {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

            <div class="container">
        <h1>KFA í¬ë¡¤ëŸ¬ ëŒ€ì‹œë³´ë“œ</h1>
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="/dashboard" style="background: #6c757d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 0 10px;">ğŸ“Š Firebase CRUD Dashboard</a>
            <a href="/" style="background: #667eea; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 0 10px;">ğŸ  í¬ë¡¤ë§ ëŒ€ì‹œë³´ë“œ</a>
        </div>
        
        <div class="section">
            <h2>ë¦¬ê·¸ ëª©ë¡ (leagues.csv) <span id="firebaseStatus" style="font-size: 12px; color: #28a745;">ğŸ”¥ Firebase ì—°ë™</span></h2>
            <textarea id="csvEditor" placeholder="CSV ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤..."></textarea>
            <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
                <button id="saveCsvBtn">Firebaseì— ì €ì¥</button>
                <button id="refreshCsvBtn" style="background-color: #17a2b8;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <div id="csvSyncStatus" style="font-size: 12px; color: #666; margin-left: 10px;">
                    ğŸ’¡ ì´ì œ ì›¹ì—ì„œ ì§ì ‘ í¸ì§‘í•˜ê³  ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
                </div>
            </div>
        </div>

        <div class="section">
            <h2>í¬ë¡¤ë§ ì‹¤í–‰ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</h2>
            <div id="crawlingFilters">
                <div class="filter-row">
                    <div class="control-grid">
                        <input type="text" placeholder="íŠ¹ì • ë…„ë„ (e.g., 2025)" class="year-filter">
                        <input type="text" placeholder="íŠ¹ì • ì›” (e.g., 05)" class="month-filter">
                        <input type="text" placeholder="ë¦¬ê·¸ëª… ì¼ë¶€ ê²€ìƒ‰" class="league-filter">
                        <button class="remove-filter-btn" onclick="removeFilterRow(this)" style="background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">âŒ</button>
                    </div>
                </div>
            </div>
            <div style="margin: 10px 0;">
                <button id="addFilterBtn" style="background-color: #28a745; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer;">â• í•„í„° ì¶”ê°€</button>
                <button id="clearAllFiltersBtn" style="background-color: #6c757d; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer; margin-left: 10px;">ğŸ§¹ ëª¨ë“  í•„í„° ì´ˆê¸°í™”</button>
            </div>
            <div class="buttons" style="margin-top: 15px;">
                <button id="crawlBtn">1. ë°ì´í„° í¬ë¡¤ë§ ì‹œì‘</button>
                <button id="stopBtn">ğŸ›‘ í¬ë¡¤ë§ ì¤‘ë‹¨</button>
            </div>
        </div>

        <div class="section">
            <h2>Firebase ì—…ë¡œë“œ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</h2>
            <div id="uploadFilters">
                <div class="filter-row">
                    <div class="control-grid">
                        <input type="text" placeholder="íŠ¹ì • ë…„ë„ (e.g., 2025)" class="upload-year-filter">
                        <input type="text" placeholder="íŠ¹ì • ì›” (e.g., 05)" class="upload-month-filter">
                        <input type="text" placeholder="ë¦¬ê·¸ëª… ì¼ë¶€ ê²€ìƒ‰" class="upload-league-filter">
                        <button class="remove-upload-filter-btn" onclick="removeUploadFilterRow(this)" style="background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">âŒ</button>
                    </div>
                </div>
            </div>
            <div style="margin: 10px 0;">
                <button id="addUploadFilterBtn" style="background-color: #28a745; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer;">â• ì—…ë¡œë“œ í•„í„° ì¶”ê°€</button>
                <button id="clearAllUploadFiltersBtn" style="background-color: #6c757d; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer; margin-left: 10px;">ğŸ§¹ ëª¨ë“  ì—…ë¡œë“œ í•„í„° ì´ˆê¸°í™”</button>
            </div>
            <div class="buttons" style="margin-top: 15px;">
                <button id="uploadBtn">2. Firestoreì— ì—…ë¡œë“œ</button>
                <button id="stopUploadBtn" style="background-color: #dc3545; display: none;">ğŸ›‘ ì—…ë¡œë“œ ì¤‘ë‹¨</button>
                <button id="copyFiltersBtn" style="background-color: #6c757d;">í¬ë¡¤ë§ í•„í„° ë³µì‚¬</button>
            </div>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                ğŸ’¡ íŒ: í•„í„°ë¥¼ ë¹„ì›Œë‘ë©´ ëª¨ë“  ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•©ë‹ˆë‹¤. "í¬ë¡¤ë§ í•„í„° ë³µì‚¬" ë²„íŠ¼ìœ¼ë¡œ ìœ„ì˜ í¬ë¡¤ë§ ì¡°ê±´ì„ ì‰½ê²Œ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
        </div>
        
        <div id="logContainer">ì‘ì—… ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const crawlBtn = document.getElementById('crawlBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const stopBtn = document.getElementById('stopBtn');
        const stopUploadBtn = document.getElementById('stopUploadBtn');
        const logContainer = document.getElementById('logContainer');
        const csvEditor = document.getElementById('csvEditor');
        const saveCsvBtn = document.getElementById('saveCsvBtn');
        const refreshCsvBtn = document.getElementById('refreshCsvBtn');
        
        // ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ì¶”ì 
        let currentProcesses = new Map();

        // ë¡œê·¸ íˆìŠ¤í† ë¦¬ ë³µì› ê¸°ëŠ¥
        socket.on('log-history', (history) => {
            logContainer.innerHTML = 'ğŸ”„ ë¡œê·¸ íˆìŠ¤í† ë¦¬ ë³µì› ì¤‘...\n';
            setTimeout(() => {
                logContainer.innerHTML = '';
                history.forEach(entry => {
                    logContainer.innerHTML += `[${new Date(entry.timestamp).toLocaleTimeString()}] ${entry.message}`;
                });
                logContainer.scrollTop = logContainer.scrollHeight;
            }, 100);
        });

        const addFilterBtn = document.getElementById('addFilterBtn');
        const clearAllFiltersBtn = document.getElementById('clearAllFiltersBtn');
        const addUploadFilterBtn = document.getElementById('addUploadFilterBtn');
        const clearAllUploadFiltersBtn = document.getElementById('clearAllUploadFiltersBtn');
        const copyFiltersBtn = document.getElementById('copyFiltersBtn');

        // ë‹¤ì¤‘ í•„í„° ê´€ë¦¬ í•¨ìˆ˜ë“¤
        function addFilterRow() {
            const crawlingFilters = document.getElementById('crawlingFilters');
            const newRow = document.createElement('div');
            newRow.className = 'filter-row';
            newRow.innerHTML = `
                <div class="control-grid">
                    <input type="text" placeholder="íŠ¹ì • ë…„ë„ (e.g., 2025)" class="year-filter">
                    <input type="text" placeholder="íŠ¹ì • ì›” (e.g., 05)" class="month-filter">
                    <input type="text" placeholder="ë¦¬ê·¸ëª… ì¼ë¶€ ê²€ìƒ‰" class="league-filter">
                    <button class="remove-filter-btn" onclick="removeFilterRow(this)" style="background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">âŒ</button>
                </div>
            `;
            crawlingFilters.appendChild(newRow);
        }

        function removeFilterRow(btn) {
            const filterRows = document.querySelectorAll('#crawlingFilters .filter-row');
            if (filterRows.length > 1) {
                btn.closest('.filter-row').remove();
            } else {
                alert('ìµœì†Œ í•˜ë‚˜ì˜ í•„í„°ëŠ” ìœ ì§€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
            }
        }

        function clearAllFilters() {
            const filterRows = document.querySelectorAll('#crawlingFilters .filter-row');
            filterRows.forEach((row, index) => {
                if (index === 0) {
                    // ì²« ë²ˆì§¸ í–‰ì€ ìœ ì§€í•˜ê³  ê°’ë§Œ ì´ˆê¸°í™”
                    row.querySelectorAll('input').forEach(input => input.value = '');
                } else {
                    // ë‚˜ë¨¸ì§€ í–‰ì€ ì œê±°
                    row.remove();
                }
            });
        }

        function addUploadFilterRow() {
            const uploadFilters = document.getElementById('uploadFilters');
            const newRow = document.createElement('div');
            newRow.className = 'filter-row';
            newRow.innerHTML = `
                <div class="control-grid">
                    <input type="text" placeholder="íŠ¹ì • ë…„ë„ (e.g., 2025)" class="upload-year-filter">
                    <input type="text" placeholder="íŠ¹ì • ì›” (e.g., 05)" class="upload-month-filter">
                    <input type="text" placeholder="ë¦¬ê·¸ëª… ì¼ë¶€ ê²€ìƒ‰" class="upload-league-filter">
                    <button class="remove-upload-filter-btn" onclick="removeUploadFilterRow(this)" style="background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">âŒ</button>
                </div>
            `;
            uploadFilters.appendChild(newRow);
        }

        function removeUploadFilterRow(btn) {
            const filterRows = document.querySelectorAll('#uploadFilters .filter-row');
            if (filterRows.length > 1) {
                btn.closest('.filter-row').remove();
            } else {
                alert('ìµœì†Œ í•˜ë‚˜ì˜ ì—…ë¡œë“œ í•„í„°ëŠ” ìœ ì§€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
            }
        }

        function clearAllUploadFilters() {
            const filterRows = document.querySelectorAll('#uploadFilters .filter-row');
            filterRows.forEach((row, index) => {
                if (index === 0) {
                    // ì²« ë²ˆì§¸ í–‰ì€ ìœ ì§€í•˜ê³  ê°’ë§Œ ì´ˆê¸°í™”
                    row.querySelectorAll('input').forEach(input => input.value = '');
                } else {
                    // ë‚˜ë¨¸ì§€ í–‰ì€ ì œê±°
                    row.remove();
                }
            });
        }

        function getCrawlingFilters() {
            const filters = [];
            const filterRows = document.querySelectorAll('#crawlingFilters .filter-row');
            filterRows.forEach(row => {
                const year = row.querySelector('.year-filter').value.trim();
                const month = row.querySelector('.month-filter').value.trim();
                const league = row.querySelector('.league-filter').value.trim();
                
                // ë¹ˆ í•„í„°ëŠ” ì œì™¸í•˜ê³ , í•˜ë‚˜ë¼ë„ ê°’ì´ ìˆìœ¼ë©´ í¬í•¨
                if (year || month || league) {
                    filters.push({ year, month, league });
                }
            });
            return filters;
        }

        function getUploadFilters() {
            const filters = [];
            const filterRows = document.querySelectorAll('#uploadFilters .filter-row');
            filterRows.forEach(row => {
                const year = row.querySelector('.upload-year-filter').value.trim();
                const month = row.querySelector('.upload-month-filter').value.trim();
                const league = row.querySelector('.upload-league-filter').value.trim();
                
                // ë¹ˆ í•„í„°ëŠ” ì œì™¸í•˜ê³ , í•˜ë‚˜ë¼ë„ ê°’ì´ ìˆìœ¼ë©´ í¬í•¨
                if (year || month || league) {
                    filters.push({ year, month, league });
                }
            });
            return filters;
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        addFilterBtn.addEventListener('click', addFilterRow);
        clearAllFiltersBtn.addEventListener('click', clearAllFilters);
        addUploadFilterBtn.addEventListener('click', addUploadFilterRow);
        clearAllUploadFiltersBtn.addEventListener('click', clearAllUploadFilters);

        // CSV íŒŒì¼ì„ ìƒˆë¡œê³ ì¹¨í•˜ëŠ” í•¨ìˆ˜
        async function refreshCsvContent() {
            try {
                console.log('ğŸ”„ CSV íŒŒì¼ ìƒˆë¡œê³ ì¹¨ ì¤‘...');
                const firebaseStatus = document.getElementById('firebaseStatus');
                const csvSyncStatus = document.getElementById('csvSyncStatus');
                
                firebaseStatus.textContent = 'ğŸ”„ ë¡œë”© ì¤‘...';
                firebaseStatus.style.color = '#ffc107';
                
                const response = await fetch('/leagues-csv?' + new Date().getTime()); // ìºì‹œ ë°©ì§€
                if (response.ok) {
                    const content = await response.text();
                    csvEditor.value = content;
                    console.log('âœ… CSV íŒŒì¼ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
                    console.log('ğŸ“„ í˜„ì¬ CSV ë‚´ìš©:', content);
                    
                    // Firebase ì—°ë™ ìƒíƒœ ì—…ë°ì´íŠ¸
                    firebaseStatus.textContent = 'ğŸ”¥ Firebase ì—°ë™';
                    firebaseStatus.style.color = '#28a745';
                    csvSyncStatus.textContent = 'âœ… Firebaseì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!';
                    csvSyncStatus.style.color = '#28a745';
                    
                    // 3ì´ˆ í›„ ê¸°ë³¸ ë©”ì‹œì§€ë¡œ ë³µì›
                    setTimeout(() => {
                        csvSyncStatus.textContent = 'ğŸ’¡ ì´ì œ ì›¹ì—ì„œ ì§ì ‘ í¸ì§‘í•˜ê³  ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
                        csvSyncStatus.style.color = '#666';
                    }, 3000);
                } else {
                    appendLog('âŒ leagues.csv íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    firebaseStatus.textContent = 'âŒ ì—°ê²° ì‹¤íŒ¨';
                    firebaseStatus.style.color = '#dc3545';
                }
            } catch (error) {
                appendLog(`âŒ CSV ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                const firebaseStatus = document.getElementById('firebaseStatus');
                firebaseStatus.textContent = 'âŒ ì—°ê²° ì‹¤íŒ¨';
                firebaseStatus.style.color = '#dc3545';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ CSV ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        window.addEventListener('load', refreshCsvContent);

        // CSV ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
        saveCsvBtn.addEventListener('click', async () => {
            try {
                saveCsvBtn.disabled = true;
                saveCsvBtn.textContent = 'Firebaseì— ì €ì¥ ì¤‘...';
                
                const firebaseStatus = document.getElementById('firebaseStatus');
                const csvSyncStatus = document.getElementById('csvSyncStatus');
                
                firebaseStatus.textContent = 'ğŸ”„ ì €ì¥ ì¤‘...';
                firebaseStatus.style.color = '#ffc107';
                
                const content = csvEditor.value;
                console.log('í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ì†¡í•  CSV ë‚´ìš© ê¸¸ì´:', content.length);
                console.log('CSV ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:', content.substring(0, 100));
                
                const response = await fetch('/leagues-csv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content })
                });

                if (response.ok) {
                    const responseText = await response.text();
                    appendLog('âœ… CSV íŒŒì¼ì´ Firebaseì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    console.log('ì„œë²„ ì‘ë‹µ:', responseText);
                    
                    // ì €ì¥ ì„±ê³µ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                    firebaseStatus.textContent = 'ğŸ”¥ Firebase ì—°ë™';
                    firebaseStatus.style.color = '#28a745';
                    saveCsvBtn.style.backgroundColor = '#28a745';
                    saveCsvBtn.textContent = 'Firebaseì— ì €ì¥ ì™„ë£Œ!';
                    saveCsvBtn.disabled = false; // ì¦‰ì‹œ ë²„íŠ¼ í™œì„±í™”
                    csvSyncStatus.textContent = 'âœ… Firebaseì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
                    csvSyncStatus.style.color = '#28a745';
                    
                    // 3ì´ˆ í›„ ê¸°ë³¸ ìƒíƒœë¡œ ë³µì›
                    setTimeout(() => {
                        saveCsvBtn.style.backgroundColor = '#6c757d';
                        saveCsvBtn.textContent = 'Firebaseì— ì €ì¥';
                        saveCsvBtn.disabled = false; // ë²„íŠ¼ í™œì„±í™” ë³´ì¥
                        csvSyncStatus.textContent = 'ğŸ’¡ ì´ì œ ì›¹ì—ì„œ ì§ì ‘ í¸ì§‘í•˜ê³  ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
                        csvSyncStatus.style.color = '#666';
                    }, 3000);
                } else {
                    const errorText = await response.text();
                    appendLog(`âŒ CSV íŒŒì¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorText}`);
                    console.error('ì„œë²„ ì˜¤ë¥˜:', errorText);
                    
                    firebaseStatus.textContent = 'âŒ ì €ì¥ ì‹¤íŒ¨';
                    firebaseStatus.style.color = '#dc3545';
                    
                    // ì˜¤ë¥˜ ì‹œì—ë„ ë²„íŠ¼ í™œì„±í™”
                    saveCsvBtn.disabled = false;
                    saveCsvBtn.textContent = 'Firebaseì— ì €ì¥';
                    saveCsvBtn.style.backgroundColor = '#6c757d';
                }
            } catch (error) {
                appendLog(`âŒ CSV ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                console.error('CSV ì €ì¥ ì˜¤ë¥˜:', error);
                
                const firebaseStatus = document.getElementById('firebaseStatus');
                firebaseStatus.textContent = 'âŒ ì €ì¥ ì‹¤íŒ¨';
                firebaseStatus.style.color = '#dc3545';
                
                // ì˜ˆì™¸ ë°œìƒ ì‹œì—ë„ ë²„íŠ¼ í™œì„±í™”
                saveCsvBtn.disabled = false;
                saveCsvBtn.textContent = 'Firebaseì— ì €ì¥';
                saveCsvBtn.style.backgroundColor = '#6c757d';
            } finally {
                // finally ë¸”ë¡ì—ì„œ í™•ì‹¤íˆ ë²„íŠ¼ í™œì„±í™”
                if (saveCsvBtn.textContent.includes('ì €ì¥ ì¤‘')) {
                    saveCsvBtn.disabled = false;
                    saveCsvBtn.textContent = 'Firebaseì— ì €ì¥';
                    saveCsvBtn.style.backgroundColor = '#6c757d';
                }
            }
        });

        function disableButtons() {
            crawlBtn.disabled = true;
            uploadBtn.disabled = true;
        }

        function enableButtons() {
            crawlBtn.disabled = false;
            uploadBtn.disabled = false;
            stopBtn.style.display = 'none';
            stopUploadBtn.style.display = 'none';
        }

        function showStopButton(processType) {
            if (processType === 'crawling') {
                stopBtn.style.display = 'inline-block';
            } else if (processType === 'uploading') {
                stopUploadBtn.style.display = 'inline-block';
            }
        }

        function hideStopButton(processType) {
            if (processType === 'crawling') {
                stopBtn.style.display = 'none';
            } else if (processType === 'uploading') {
                stopUploadBtn.style.display = 'none';
            }
        }

        function appendLog(message) {
            // ANSI ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤(ì»¬ëŸ¬ ì½”ë“œ)ë¥¼ ì œê±°í•˜ëŠ” ì •ê·œì‹
            const cleanMessage = message.replace(/[\u001b\u009b][[()#;?]*.?[0-9]{1,4}(?:;[0-9]{0,4})*.?[0-9A-ORZcf-nqry=><]/g, '');
            logContainer.innerHTML += cleanMessage.replace(/\n/g, '<br>');
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        socket.on('connect', () => {
            logContainer.innerHTML = 'âœ… ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.<br>';
        });

        socket.on('log', (message) => {
            if (message.includes('í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤')) {
                enableButtons();
            }
            appendLog(message);
        });

        // í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ì´ë²¤íŠ¸
        socket.on('process-started', (data) => {
            const { processId, type } = data;
            currentProcesses.set(processId, type);
            showStopButton(type);
            console.log(`í”„ë¡œì„¸ìŠ¤ ì‹œì‘: ${processId} (${type})`);
        });

        // í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì´ë²¤íŠ¸
        socket.on('process-ended', (data) => {
            const { processId, type } = data;
            currentProcesses.delete(processId);
            hideStopButton(type);
            enableButtons();
            console.log(`í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ: ${processId} (${type})`);
        });

        crawlBtn.addEventListener('click', () => {
            logContainer.innerHTML = '';
            disableButtons();
            
            const filters = getCrawlingFilters();
            
            if (filters.length === 0) {
                // í•„í„°ê°€ ì—†ìœ¼ë©´ ì „ì²´ í¬ë¡¤ë§
                const options = { year: '', month: '', league: '' };
                appendLog('ğŸ“‹ ì „ì²´ í¬ë¡¤ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤...\n');
                socket.emit('start-crawling', options);
            } else {
                // ë‹¤ì¤‘ í•„í„°ë¡œ ìˆœì°¨ ì‹¤í–‰
                appendLog(`ğŸ“‹ ${filters.length}ê°œì˜ í•„í„° ì¡°ê±´ìœ¼ë¡œ í¬ë¡¤ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤...\n`);
                filters.forEach((filter, index) => {
                    appendLog(`  ${index + 1}. ë…„ë„: ${filter.year || 'ì „ì²´'}, ì›”: ${filter.month || 'ì „ì²´'}, ë¦¬ê·¸: ${filter.league || 'ì „ì²´'}\n`);
                });
                appendLog('\n');
                
                let currentFilterIndex = 0;
                
                function runNextCrawling() {
                    if (currentFilterIndex < filters.length) {
                        const options = filters[currentFilterIndex];
                        appendLog(`ğŸš€ [${currentFilterIndex + 1}/${filters.length}] í¬ë¡¤ë§ ì‹¤í–‰ ì¤‘...\n`);
                        socket.emit('start-crawling', options);
                        currentFilterIndex++;
                    }
                }
                
                // í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹œ ë‹¤ìŒ í¬ë¡¤ë§ ì‹¤í–‰ì„ ìœ„í•œ ì„ì‹œ í•¸ë“¤ëŸ¬
                const multiCrawlingEndHandler = (data) => {
                    if (data.type === 'crawling') {
                        setTimeout(() => {
                            if (currentFilterIndex < filters.length) {
                                runNextCrawling();
                            } else {
                                // ëª¨ë“  í¬ë¡¤ë§ ì™„ë£Œ
                                appendLog(`\nğŸ‰ ëª¨ë“  í¬ë¡¤ë§ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (ì´ ${filters.length}ê°œ ì¡°ê±´)\n`);
                                enableButtons();
                                socket.off('process-ended', multiCrawlingEndHandler);
                            }
                        }, 1000);
                    }
                };
                
                socket.on('process-ended', multiCrawlingEndHandler);
                
                // ì²« ë²ˆì§¸ í¬ë¡¤ë§ ì‹œì‘
                runNextCrawling();
            }
        });

        uploadBtn.addEventListener('click', () => {
            logContainer.innerHTML = '';
            disableButtons();
            
            const filters = getUploadFilters();
            
            if (filters.length === 0) {
                // í•„í„°ê°€ ì—†ìœ¼ë©´ ì „ì²´ ì—…ë¡œë“œ
                const uploadOptions = { year: '', month: '', league: '' };
                appendLog('ğŸ“‹ ì „ì²´ ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•©ë‹ˆë‹¤...\n');
                socket.emit('start-uploading', uploadOptions);
            } else {
                // ë‹¤ì¤‘ í•„í„°ë¡œ ìˆœì°¨ ì‹¤í–‰
                appendLog(`ğŸ“‹ ${filters.length}ê°œì˜ í•„í„° ì¡°ê±´ìœ¼ë¡œ ì—…ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...\n`);
                filters.forEach((filter, index) => {
                    appendLog(`  ${index + 1}. ë…„ë„: ${filter.year || 'ì „ì²´'}, ì›”: ${filter.month || 'ì „ì²´'}, ë¦¬ê·¸: ${filter.league || 'ì „ì²´'}\n`);
                });
                appendLog('\n');
                
                let currentFilterIndex = 0;
                
                function runNextUpload() {
                    if (currentFilterIndex < filters.length) {
                        const uploadOptions = filters[currentFilterIndex];
                        appendLog(`â˜ï¸ [${currentFilterIndex + 1}/${filters.length}] ì—…ë¡œë“œ ì‹¤í–‰ ì¤‘...\n`);
                        socket.emit('start-uploading', uploadOptions);
                        currentFilterIndex++;
                    }
                }
                
                // í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹œ ë‹¤ìŒ ì—…ë¡œë“œ ì‹¤í–‰ì„ ìœ„í•œ ì„ì‹œ í•¸ë“¤ëŸ¬
                const multiUploadEndHandler = (data) => {
                    if (data.type === 'uploading') {
                        setTimeout(() => {
                            if (currentFilterIndex < filters.length) {
                                runNextUpload();
                            } else {
                                // ëª¨ë“  ì—…ë¡œë“œ ì™„ë£Œ
                                appendLog(`\nğŸ‰ ëª¨ë“  ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (ì´ ${filters.length}ê°œ ì¡°ê±´)\n`);
                                enableButtons();
                                socket.off('process-ended', multiUploadEndHandler);
                            }
                        }, 1000);
                    }
                };
                
                socket.on('process-ended', multiUploadEndHandler);
                
                // ì²« ë²ˆì§¸ ì—…ë¡œë“œ ì‹œì‘
                runNextUpload();
            }
        });

        // í¬ë¡¤ë§ í•„í„° ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸
        copyFiltersBtn.addEventListener('click', () => {
            const crawlingFilters = getCrawlingFilters();
            const uploadFiltersContainer = document.getElementById('uploadFilters');
            
            // ê¸°ì¡´ ì—…ë¡œë“œ í•„í„° ëª¨ë‘ ì œê±°
            uploadFiltersContainer.innerHTML = '';
            
            if (crawlingFilters.length === 0) {
                // í¬ë¡¤ë§ í•„í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ì—…ë¡œë“œ í•„í„° í•˜ë‚˜ ìƒì„±
                uploadFiltersContainer.innerHTML = `
                    <div class="filter-row">
                        <div class="control-grid">
                            <input type="text" placeholder="íŠ¹ì • ë…„ë„ (e.g., 2025)" class="upload-year-filter">
                            <input type="text" placeholder="íŠ¹ì • ì›” (e.g., 05)" class="upload-month-filter">
                            <input type="text" placeholder="ë¦¬ê·¸ëª… ì¼ë¶€ ê²€ìƒ‰" class="upload-league-filter">
                            <button class="remove-upload-filter-btn" onclick="removeUploadFilterRow(this)" style="background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">âŒ</button>
                        </div>
                    </div>
                `;
            } else {
                // í¬ë¡¤ë§ í•„í„°ë¥¼ ì—…ë¡œë“œ í•„í„°ë¡œ ë³µì‚¬
                crawlingFilters.forEach(filter => {
                    const newRow = document.createElement('div');
                    newRow.className = 'filter-row';
                    newRow.innerHTML = `
                        <div class="control-grid">
                            <input type="text" placeholder="íŠ¹ì • ë…„ë„ (e.g., 2025)" class="upload-year-filter" value="${filter.year || ''}">
                            <input type="text" placeholder="íŠ¹ì • ì›” (e.g., 05)" class="upload-month-filter" value="${filter.month || ''}">
                            <input type="text" placeholder="ë¦¬ê·¸ëª… ì¼ë¶€ ê²€ìƒ‰" class="upload-league-filter" value="${filter.league || ''}">
                            <button class="remove-upload-filter-btn" onclick="removeUploadFilterRow(this)" style="background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">âŒ</button>
                        </div>
                    `;
                    uploadFiltersContainer.appendChild(newRow);
                });
            }
            
            // ì‹œê°ì  í”¼ë“œë°±
            copyFiltersBtn.textContent = 'ë³µì‚¬ ì™„ë£Œ!';
            copyFiltersBtn.style.backgroundColor = '#28a745';
            setTimeout(() => {
                copyFiltersBtn.textContent = 'í¬ë¡¤ë§ í•„í„° ë³µì‚¬';
                copyFiltersBtn.style.backgroundColor = '#6c757d';
            }, 1000);
        });

         // í¬ë¡¤ë§ ì¤‘ë‹¨ ë²„íŠ¼ ì´ë²¤íŠ¸
         stopBtn.addEventListener('click', () => {
             const crawlingProcess = Array.from(currentProcesses.entries()).find(([id, type]) => type === 'crawling');
             if (crawlingProcess) {
                 const [processId] = crawlingProcess;
                 socket.emit('stop-process', { processId });
                 stopBtn.disabled = true;
                 stopBtn.textContent = 'ì¤‘ë‹¨ ì¤‘...';
                 
                 // 5ì´ˆ í›„ ë²„íŠ¼ ë³µì› (ì•ˆì „ì¥ì¹˜)
                 setTimeout(() => {
                     stopBtn.disabled = false;
                     stopBtn.textContent = 'ğŸ›‘ í¬ë¡¤ë§ ì¤‘ë‹¨';
                                   }, 5000);
              }
          });

          // CSV ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì´ë²¤íŠ¸
          refreshCsvBtn.addEventListener('click', async () => {
              refreshCsvBtn.disabled = true;
              refreshCsvBtn.textContent = 'ìƒˆë¡œê³ ì¹¨ ì¤‘...';
              
              try {
                  await refreshCsvContent();
                  appendLog('âœ… CSV íŒŒì¼ì´ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
              } catch (error) {
                  appendLog(`âŒ CSV ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ${error.message}`);
              } finally {
                  refreshCsvBtn.disabled = false;
                  refreshCsvBtn.textContent = 'ğŸ”„ ìƒˆë¡œê³ ì¹¨';
              }
          });

         // ì—…ë¡œë“œ ì¤‘ë‹¨ ë²„íŠ¼ ì´ë²¤íŠ¸
         stopUploadBtn.addEventListener('click', () => {
             const uploadingProcess = Array.from(currentProcesses.entries()).find(([id, type]) => type === 'uploading');
             if (uploadingProcess) {
                 const [processId] = uploadingProcess;
                 socket.emit('stop-process', { processId });
                 stopUploadBtn.disabled = true;
                 stopUploadBtn.textContent = 'ì¤‘ë‹¨ ì¤‘...';
                 
                 // 5ì´ˆ í›„ ë²„íŠ¼ ë³µì› (ì•ˆì „ì¥ì¹˜)
                 setTimeout(() => {
                     stopUploadBtn.disabled = false;
                     stopUploadBtn.textContent = 'ğŸ›‘ ì—…ë¡œë“œ ì¤‘ë‹¨';
                 }, 5000);
             }
         });
    </script>
</body>
</html> 