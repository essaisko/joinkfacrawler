<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KFA Crawler Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }
        h1 {
            color: #1877f2;
        }
        .container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 80%;
            max-width: 800px;
        }
        .buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        button {
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: #fff;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        button:active:not(:disabled) {
            transform: scale(0.98);
        }
        #crawlBtn { background-color: #42b72a; }
        #crawlBtn:hover:not(:disabled) { background-color: #36a420; }
        #uploadBtn { background-color: #1877f2; }
        #uploadBtn:hover:not(:disabled) { background-color: #166fe5; }
        #stopBtn { 
            background-color: #dc3545; 
            display: none;
        }
        #stopBtn:hover:not(:disabled) { background-color: #c82333; }
        
        #logContainer {
            background-color: #000;
            color: #fff;
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            padding: 15px;
            border-radius: 6px;
            height: calc(100vh - 100px);
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .section {
            margin-top: 25px;
        }
        .section h2 {
            font-size: 18px;
            color: #1c1e21;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        textarea {
            width: 100%;
            box-sizing: border-box;
            height: 150px;
            border: 1px solid #ccd0d5;
            border-radius: 6px;
            padding: 10px;
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 13px;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .control-grid input {
            padding: 10px;
            border: 1px solid #ccd0d5;
            border-radius: 6px;
            font-size: 14px;
        }
        #saveCsvBtn {
            background-color: #6c757d;
            margin-top: 10px;
        }
         #saveCsvBtn:hover:not(:disabled) {
            background-color: #5a6268;
        }
        #copyFiltersBtn:hover:not(:disabled) {
            background-color: #5a6268;
        }
        /* === ë¦¬ê·¸ë³„ í…Œì´ë¸” UI ì¶”ê°€ === */
        #leagueTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        /* ì›” ì„ íƒ ë²„íŠ¼ ê·¸ë£¹ */
        .month-buttons { display:flex; gap:2px; overflow-x:auto; }
        .month-btn { font-size:12px; padding:2px 6px; border:none; border-radius:3px; cursor:pointer; background:#e9ecef; }
        .month-btn.active { background:#007bff; color:#fff; }
        /* ì „ì—­ ì›” ì‘ì—… ë²„íŠ¼ */
        .crawl-global-btn{ background:#28a745; color:#fff; border:none; }
        .upload-global-btn{ background:#ff9800; color:#fff; border:none; }
        .crawl-global-btn:disabled,.upload-global-btn:disabled{ opacity:0.6; }
        #leagueTable th, #leagueTable td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: center;
        }
        #leagueTable th {
            background-color: #f8f9fa;
        }
        .action-btn {
            padding: 4px 10px;
            font-size: 13px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: #fff;
        }
        .crawl-row-btn { background-color: #42b72a; }
        .crawl-row-btn:hover { background-color: #36a420; }
        .upload-row-btn { background-color: #1877f2; }
        .upload-row-btn:hover { background-color: #166fe5; }
        /* ë ˆì´ì•„ì›ƒ ê°œì„  */
        .main-wrapper { 
            display: flex; 
            gap: 20px; 
            align-items: flex-start; 
            width:100%; 
            box-sizing: border-box; 
            flex-wrap:nowrap;
            height: calc(100vh - 40px);
        }
        .left-area { 
            flex: 1 1 65%; 
            min-width:0; 
            overflow-y: auto;
            max-height: 100%;
        }
        .log-panel { 
            flex: 0 0 33%; 
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(0, 0, 0, 0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        /* ì™¼ìª½ ì»¨í…Œì´ë„ˆ ìµœëŒ€í­ ì œê±° */
        .left-area .container { width:100%; max-width:none; }
        /* ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        #loginOverlay input { padding: 10px; margin: 5px 0; width: 250px; font-size: 14px; }
        #loginOverlay button { padding: 10px 20px; background: #1877f2; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        #loginError { margin-top: 10px; color: #dc3545; font-size: 13px; }
        /* ë¶ˆí•„ìš”í•œ êµ¬ë²„ì „ í•„í„° ì„¹ì…˜ ìˆ¨ê¹€ */
        #legacyFilters, #legacyUploads { display:none; }
        /* ì‘ì—… í í˜„í™© UI */
        #queueStatusSection { background: #fff; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); padding: 15px; margin-bottom: 20px; }
        #queueStatusSection h3 { margin-top: 0; font-size: 16px; color: #1c1e21; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        #queueStatusSection div { font-family: 'Menlo', 'Monaco', monospace; font-size: 13px; margin-top: 8px; }
        #runningJob, #waitingJobs { display: inline-block; padding: 4px 8px; border-radius: 4px; }
        #runningJob { background-color: #e7f3ff; border: 1px solid #cce0f5; color: #004085; }
        #waitingJobs { background-color: #f8f9fa; border: 1px solid #dee2e6; color: #343a40; }
        #controlButtons {margin-top:10px;}
        #controlButtons button{padding:6px 12px;font-size:13px;border:none;border-radius:4px;color:#fff;cursor:pointer}
        #stopBtnGlobal{background:#dc3545;display:none}
        #stopUploadBtnGlobal{background:#dc3545;display:none}
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ -->
    <div id="loginOverlay" style="display:none;">
        <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
        <input type="text" id="loginUser" placeholder="ì•„ì´ë””" />
        <input type="password" id="loginPass" placeholder="ë¹„ë°€ë²ˆí˜¸" />
        <label style="font-size:13px; margin:5px 0;"><input type="checkbox" id="rememberMe" /> ìë™ ë¡œê·¸ì¸</label>
        <button id="loginBtn">ë¡œê·¸ì¸</button>
        <div id="loginError"></div>
    </div>

    <div class="main-wrapper" id="dashboardWrapper" style="display:none;">
        <div class="container left-area">
        <h1>KFA í¬ë¡¤ëŸ¬ ëŒ€ì‹œë³´ë“œ</h1>
            <div style="text-align: center; margin-bottom: 20px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center;">
            <a href="/dashboard" style="background: #6c757d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 0 10px;">ğŸ“Š Firebase CRUD Dashboard</a>
            <a href="/" style="background: #667eea; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 0 10px;">ğŸ  í¬ë¡¤ë§ ëŒ€ì‹œë³´ë“œ</a>
                <button id="logoutBtn" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:5px;">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            
            <!-- ì‘ì—… í í˜„í™© -->
            <div id="queueStatusSection">
                <h3>ğŸš€ ì‘ì—… í í˜„í™©</h3>
                <div>ì‹¤í–‰ì¤‘: <span id="runningJob">ì—†ìŒ</span></div>
                <div>ëŒ€ê¸°ì¤‘: <span id="waitingJobs">ì—†ìŒ</span></div>
                <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button id="stopCrawlBtn" style="background:#dc3545; color:#fff; border:none; padding:6px 12px; border-radius:4px; display:none;">ğŸ›‘ í¬ë¡¤ë§ ì¤‘ë‹¨</button>
                    <button id="stopUploadBtn" style="background:#dc3545; color:#fff; border:none; padding:6px 12px; border-radius:4px; display:none;">ğŸ›‘ ì—…ë¡œë“œ ì¤‘ë‹¨</button>
                </div>
        </div>
        
        <!-- Git ì»¤ë°‹ ì •ë³´ í‘œì‹œ -->
        <div id="gitInfo" style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 12px; margin-bottom: 20px; font-size: 13px; color: #495057;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <span style="font-weight: bold; color: #28a745;">ğŸ”„ í˜„ì¬ ë²„ì „:</span>
                    <span id="gitCommitHash" style="font-family: monospace; background: #e9ecef; padding: 2px 6px; border-radius: 3px;">ë¡œë”©ì¤‘...</span>
                    <span id="gitCommitDate" style="color: #6c757d;">ë¡œë”©ì¤‘...</span>
                </div>
                <button id="refreshGitInfo" style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="gitCommitMessage" style="margin-top: 8px; font-style: italic; color: #6c757d;">ë¡œë”©ì¤‘...</div>
        </div>
        
        <div class="section">
            <h2>ë¦¬ê·¸ ëª©ë¡ (leagues.csv) <span id="firebaseStatus" style="font-size: 12px; color: #28a745;">ğŸ”¥ Firebase ì—°ë™</span></h2>
            
            <!-- ìƒˆ ë¦¬ê·¸ ì¶”ê°€ í¼ -->
            <div id="newLeagueForm" style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; margin-bottom: 15px; display: none;">
                <h3 style="margin-top: 0; color: #495057;">ğŸ†• ìƒˆ ë¦¬ê·¸ ì¶”ê°€</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="newLeagueTag" placeholder="ë¦¬ê·¸ íƒœê·¸ (e.g., k1)" style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                    <input type="text" id="newRegionTag" placeholder="ì§€ì—­ íƒœê·¸ (ë¹ˆì¹¸ ê°€ëŠ¥)" style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                    <input type="text" id="newYear" placeholder="ë…„ë„ (e.g., 2025)" style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                    <input type="text" id="newLeagueTitle" placeholder="ë¦¬ê·¸ ì´ë¦„ (e.g., Kë¦¬ê·¸1)" style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                    <input type="text" id="newMatchIdx" placeholder="ë§¤ì¹˜ ì¸ë±ìŠ¤ (ê¸´ ID ë¬¸ìì—´)" style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="addNewLeagueBtn" style="background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">âœ… ë¦¬ê·¸ ì¶”ê°€</button>
                    <button id="cancelNewLeagueBtn" style="background-color: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">âŒ ì·¨ì†Œ</button>
                </div>
                <div style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                    ğŸ’¡ íŒ: ì§€ì—­ íƒœê·¸ëŠ” ë¹ˆì¹¸ìœ¼ë¡œ ë‘ì–´ë„ ë©ë‹ˆë‹¤ (ì „êµ­ ë¦¬ê·¸ì¸ ê²½ìš°). ë§¤ì¹˜ ì¸ë±ìŠ¤ëŠ” KFA ì‚¬ì´íŠ¸ì—ì„œ ê°€ì ¸ì˜¨ ê³ ìœ  IDì…ë‹ˆë‹¤.
                </div>
            </div>
            
            <textarea id="csvEditor" placeholder="CSV ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤..."></textarea>
                <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center; flex-wrap:wrap;">
                <button id="saveCsvBtn">Firebaseì— ì €ì¥</button>
                <button id="refreshCsvBtn" style="background-color: #17a2b8;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <button id="showNewLeagueFormBtn" style="background-color: #28a745;">â• ìƒˆ ë¦¬ê·¸ ì¶”ê°€</button>
                <div id="csvSyncStatus" style="font-size: 12px; color: #666; margin-left: 10px;">
                    ğŸ’¡ ì´ì œ ì›¹ì—ì„œ ì§ì ‘ í¸ì§‘í•˜ê³  ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
                </div>
            </div>

                <!-- ë¦¬ê·¸ë³„ ì•¡ì…˜ í…Œì´ë¸” -->
                <div id="leagueTableSection" style="margin-top: 25px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; margin-bottom:10px;">
                        <h3 style="margin:0;">ğŸ·ï¸ ê°œë³„ ë¦¬ê·¸ ì‘ì—…</h3>
                        <div id="globalMonthControls" style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                            <div id="globalMonthButtons" class="month-buttons"></div>
                            <button id="crawlMonthAllBtn" class="action-btn crawl-global-btn" style="padding:4px 12px;">ì›” ì „ì²´ í¬ë¡¤ë§</button>
                            <button id="uploadMonthAllBtn" class="action-btn upload-global-btn" style="padding:4px 12px;">ì›” ì „ì²´ ì—…ë¡œë“œ</button>
                        </div>
                        <button id="refreshTableBtn" style="background-color:#17a2b8; color:white; border:none; padding: 6px 12px; border-radius:4px; font-size:12px;">í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <div style="margin-bottom:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                        <button id="crawlSelectedBtn" class="action-btn crawl-row-btn">ì„ íƒ í¬ë¡¤ë§</button>
                        <button id="uploadSelectedBtn" class="action-btn upload-row-btn">ì„ íƒ ì—…ë¡œë“œ</button>
                        <label style="font-size:13px;"><input type="checkbox" id="selectAllLeagues" /> ì „ì²´ ì„ íƒ</label>
        </div>

                    <div style="overflow-x:auto;">
                        <table id="leagueTable">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>íƒœê·¸</th>
                                    <th>ì§€ì—­</th>
                                    <th>ë…„ë„</th>
                                    <th>ì›”</th>
                                    <th style="text-align:left;">ë¦¬ê·¸ ì´ë¦„</th>
                                    <th>í¬ë¡¤ë§</th>
                                    <th>ì—…ë¡œë“œ</th>
                                    <th>ìµœê·¼ í¬ë¡¤ë§</th>
                                    <th>ìµœê·¼ ì—…ë¡œë“œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">ğŸ•’ "ìµœê·¼ ì—…ë¡œë“œ"ëŠ” ì´ í˜ì´ì§€ì—ì„œ ì‹¤í–‰í•œ ì‹œì ì„ í‘œì‹œí•©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <div class="section" id="legacyFilters">
            <h2>í¬ë¡¤ë§ ì‹¤í–‰ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</h2>
            <div id="crawlingFilters">
                <div class="filter-row">
                    <div class="control-grid">
                        <input type="text" placeholder="íŠ¹ì • ë…„ë„ (e.g., 2025)" class="year-filter">
                        <input type="text" placeholder="íŠ¹ì • ì›” (e.g., 05)" class="month-filter">
                        <input type="text" placeholder="ë¦¬ê·¸ëª… ë˜ëŠ” íƒœê·¸ (e.g., Kë¦¬ê·¸1, k1)" class="league-filter">
                        <button class="remove-filter-btn" onclick="removeFilterRow(this)" style="background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">âŒ</button>
                    </div>
                </div>
            </div>
            <div style="margin: 10px 0;">
                <button id="addFilterBtn" style="background-color: #28a745; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer;">â• í•„í„° ì¶”ê°€</button>
                <button id="clearAllFiltersBtn" style="background-color: #6c757d; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer; margin-left: 10px;">ğŸ§¹ ëª¨ë“  í•„í„° ì´ˆê¸°í™”</button>
            </div>
            <div class="buttons" style="margin-top: 15px;">
                <button id="crawlBtn">1. ë°ì´í„° í¬ë¡¤ë§ ì‹œì‘</button>
                <button id="stopBtn">ğŸ›‘ í¬ë¡¤ë§ ì¤‘ë‹¨</button>
            </div>
        </div>

            <div class="section" id="legacyUploads">
            <h2>Firebase ì—…ë¡œë“œ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</h2>
            <div id="uploadFilters">
                <div class="filter-row">
                    <div class="control-grid">
                        <input type="text" placeholder="íŠ¹ì • ë…„ë„ (e.g., 2025)" class="upload-year-filter">
                        <input type="text" placeholder="íŠ¹ì • ì›” (e.g., 05)" class="upload-month-filter">
                        <input type="text" placeholder="ë¦¬ê·¸ëª… ì¼ë¶€ ê²€ìƒ‰" class="upload-league-filter">
                        <button class="remove-upload-filter-btn" onclick="removeUploadFilterRow(this)" style="background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">âŒ</button>
                    </div>
                </div>
            </div>
            <div style="margin: 10px 0;">
                <button id="addUploadFilterBtn" style="background-color: #28a745; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer;">â• ì—…ë¡œë“œ í•„í„° ì¶”ê°€</button>
                <button id="clearAllUploadFiltersBtn" style="background-color: #6c757d; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer; margin-left: 10px;">ğŸ§¹ ëª¨ë“  ì—…ë¡œë“œ í•„í„° ì´ˆê¸°í™”</button>
            </div>
            <div class="buttons" style="margin-top: 15px;">
                <button id="uploadBtn">2. Firestoreì— ì—…ë¡œë“œ</button>
                <button id="stopUploadBtn" style="background-color: #dc3545; display: none;">ğŸ›‘ ì—…ë¡œë“œ ì¤‘ë‹¨</button>
                <button id="copyFiltersBtn" style="background-color: #6c757d;">í¬ë¡¤ë§ í•„í„° ë³µì‚¬</button>
            </div>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                ğŸ’¡ íŒ: í•„í„°ë¥¼ ë¹„ì›Œë‘ë©´ ëª¨ë“  ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•©ë‹ˆë‹¤. "í¬ë¡¤ë§ í•„í„° ë³µì‚¬" ë²„íŠ¼ìœ¼ë¡œ ìœ„ì˜ í¬ë¡¤ë§ ì¡°ê±´ì„ ì‰½ê²Œ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            </div>
        </div>
        
        <!-- ë¡œê·¸ íŒ¨ë„ ì˜¤ë¥¸ìª½ -->
        <div class="log-panel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; font-size: 16px; color: #1c1e21;">ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸</h3>
                <button id="clearLogBtn" style="background:#6c757d; color:#fff; border:none; padding:6px 12px; border-radius:4px;">ğŸ§¹ ì§€ìš°ê¸°</button>
            </div>
            <div id="logContainer">ì‘ì—… ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const crawlBtn = document.getElementById('crawlBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const stopCrawlBtn = document.getElementById('stopCrawlBtn');
        const stopUploadBtn = document.getElementById('stopUploadBtn');
        const logContainer = document.getElementById('logContainer');
        const csvEditor = document.getElementById('csvEditor');
        const saveCsvBtn = document.getElementById('saveCsvBtn');
        const refreshCsvBtn = document.getElementById('refreshCsvBtn');
        
        // ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ì¶”ì 
        let currentProcesses = new Map();

        // === ì•ˆì •ì ì¸ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ìœ„í•œ ë°ì´í„° ì €ì¥ ===
        let parsedLeagues = [];

        // ë¡œê·¸ íˆìŠ¤í† ë¦¬ ë³µì› ê¸°ëŠ¥
        socket.on('log-history', (history) => {
            logContainer.innerHTML = 'ğŸ”„ ë¡œê·¸ íˆìŠ¤í† ë¦¬ ë³µì› ì¤‘...\n';
            setTimeout(() => {
                logContainer.innerHTML = '';
                history.forEach(entry => {
                    logContainer.innerHTML += `[${new Date(entry.timestamp).toLocaleTimeString()}] ${entry.message}`;
                });
                logContainer.scrollTop = logContainer.scrollHeight;
            }, 100);
        });

        const addFilterBtn = document.getElementById('addFilterBtn');
        const clearAllFiltersBtn = document.getElementById('clearAllFiltersBtn');
        const addUploadFilterBtn = document.getElementById('addUploadFilterBtn');
        const clearAllUploadFiltersBtn = document.getElementById('clearAllUploadFiltersBtn');
        const copyFiltersBtn = document.getElementById('copyFiltersBtn');

        // ë‹¤ì¤‘ í•„í„° ê´€ë¦¬ í•¨ìˆ˜ë“¤
        function addFilterRow() {
            const crawlingFilters = document.getElementById('crawlingFilters');
            const newRow = document.createElement('div');
            newRow.className = 'filter-row';
            newRow.innerHTML = `
                <div class="control-grid">
                    <input type="text" placeholder="íŠ¹ì • ë…„ë„ (e.g., 2025)" class="year-filter">
                    <input type="text" placeholder="íŠ¹ì • ì›” (e.g., 05)" class="month-filter">
                    <input type="text" placeholder="ë¦¬ê·¸ëª… ë˜ëŠ” íƒœê·¸ (e.g., Kë¦¬ê·¸1, k1)" class="league-filter">
                    <button class="remove-filter-btn" onclick="removeFilterRow(this)" style="background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">âŒ</button>
                </div>
            `;
            crawlingFilters.appendChild(newRow);
        }

        function removeFilterRow(btn) {
            const filterRows = document.querySelectorAll('#crawlingFilters .filter-row');
            if (filterRows.length > 1) {
                btn.closest('.filter-row').remove();
            } else {
                alert('ìµœì†Œ í•˜ë‚˜ì˜ í•„í„°ëŠ” ìœ ì§€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
            }
        }

        function clearAllFilters() {
            const filterRows = document.querySelectorAll('#crawlingFilters .filter-row');
            filterRows.forEach((row, index) => {
                if (index === 0) {
                    // ì²« ë²ˆì§¸ í–‰ì€ ìœ ì§€í•˜ê³  ê°’ë§Œ ì´ˆê¸°í™”
                    row.querySelectorAll('input').forEach(input => input.value = '');
                } else {
                    // ë‚˜ë¨¸ì§€ í–‰ì€ ì œê±°
                    row.remove();
                }
            });
        }

        function addUploadFilterRow() {
            const uploadFilters = document.getElementById('uploadFilters');
            const newRow = document.createElement('div');
            newRow.className = 'filter-row';
            newRow.innerHTML = `
                <div class="control-grid">
                    <input type="text" placeholder="íŠ¹ì • ë…„ë„ (e.g., 2025)" class="upload-year-filter">
                    <input type="text" placeholder="íŠ¹ì • ì›” (e.g., 05)" class="upload-month-filter">
                    <input type="text" placeholder="ë¦¬ê·¸ëª… ì¼ë¶€ ê²€ìƒ‰" class="upload-league-filter">
                    <button class="remove-upload-filter-btn" onclick="removeUploadFilterRow(this)" style="background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">âŒ</button>
                </div>
            `;
            uploadFilters.appendChild(newRow);
        }

        function removeUploadFilterRow(btn) {
            const filterRows = document.querySelectorAll('#uploadFilters .filter-row');
            if (filterRows.length > 1) {
                btn.closest('.filter-row').remove();
            } else {
                alert('ìµœì†Œ í•˜ë‚˜ì˜ ì—…ë¡œë“œ í•„í„°ëŠ” ìœ ì§€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
            }
        }

        function clearAllUploadFilters() {
            const filterRows = document.querySelectorAll('#uploadFilters .filter-row');
            filterRows.forEach((row, index) => {
                if (index === 0) {
                    // ì²« ë²ˆì§¸ í–‰ì€ ìœ ì§€í•˜ê³  ê°’ë§Œ ì´ˆê¸°í™”
                    row.querySelectorAll('input').forEach(input => input.value = '');
                } else {
                    // ë‚˜ë¨¸ì§€ í–‰ì€ ì œê±°
                    row.remove();
                }
            });
        }

        function getCrawlingFilters() {
            const filters = [];
            const filterRows = document.querySelectorAll('#crawlingFilters .filter-row');
            filterRows.forEach(row => {
                const year = row.querySelector('.year-filter').value.trim();
                const month = row.querySelector('.month-filter').value.trim();
                const league = row.querySelector('.league-filter').value.trim();
                
                // ë¹ˆ í•„í„°ëŠ” ì œì™¸í•˜ê³ , í•˜ë‚˜ë¼ë„ ê°’ì´ ìˆìœ¼ë©´ í¬í•¨
                if (year || month || league) {
                    filters.push({ year, month, league });
                }
            });
            return filters;
        }

        function getUploadFilters() {
            const filters = [];
            const filterRows = document.querySelectorAll('#uploadFilters .filter-row');
            filterRows.forEach(row => {
                const year = row.querySelector('.upload-year-filter').value.trim();
                const month = row.querySelector('.upload-month-filter').value.trim();
                const league = row.querySelector('.upload-league-filter').value.trim();
                
                // ë¹ˆ í•„í„°ëŠ” ì œì™¸í•˜ê³ , í•˜ë‚˜ë¼ë„ ê°’ì´ ìˆìœ¼ë©´ í¬í•¨
                if (year || month || league) {
                    filters.push({ year, month, league });
                }
            });
            return filters;
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        addFilterBtn.addEventListener('click', addFilterRow);
        clearAllFiltersBtn.addEventListener('click', clearAllFilters);
        addUploadFilterBtn.addEventListener('click', addUploadFilterRow);
        clearAllUploadFiltersBtn.addEventListener('click', clearAllUploadFilters);

        // CSV íŒŒì‹± í›„ í…Œì´ë¸” ë Œë”ë§ ë° ë°ì´í„° ì €ì¥
        function renderAndStoreLeagues(csvContent) {
            parsedLeagues = parseCsvToArray(csvContent); // íŒŒì‹±ëœ ë°ì´í„° ì €ì¥
            renderLeagueTable(parsedLeagues); // í…Œì´ë¸” ë Œë”ë§
        }

        // CSV íŒŒì¼ì„ ìƒˆë¡œê³ ì¹¨í•˜ëŠ” í•¨ìˆ˜
        async function refreshCsvContent() {
            try {
                console.log('ğŸ”„ CSV íŒŒì¼ ìƒˆë¡œê³ ì¹¨ ì¤‘...');
                const firebaseStatus = document.getElementById('firebaseStatus');
                const csvSyncStatus = document.getElementById('csvSyncStatus');
                
                firebaseStatus.textContent = 'ğŸ”„ ë¡œë”© ì¤‘...';
                firebaseStatus.style.color = '#ffc107';
                
                const response = await fetch('/leagues-csv?' + new Date().getTime()); // ìºì‹œ ë°©ì§€
                if (response.ok) {
                    const content = await response.text();
                    csvEditor.value = content;
                    console.log('âœ… CSV íŒŒì¼ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
                    
                    // === CSV íŒŒì‹± í›„ í…Œì´ë¸” ë Œë” ===
                    renderAndStoreLeagues(content);
                    
                    // Firebase ì—°ë™ ìƒíƒœ ì—…ë°ì´íŠ¸
                    firebaseStatus.textContent = 'ğŸ”¥ Firebase ì—°ë™';
                    firebaseStatus.style.color = '#28a745';
                    csvSyncStatus.textContent = 'âœ… Firebaseì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!';
                    csvSyncStatus.style.color = '#28a745';
                    
                    // 3ì´ˆ í›„ ê¸°ë³¸ ë©”ì‹œì§€ë¡œ ë³µì›
                    setTimeout(() => {
                        csvSyncStatus.textContent = 'ğŸ’¡ ì´ì œ ì›¹ì—ì„œ ì§ì ‘ í¸ì§‘í•˜ê³  ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
                        csvSyncStatus.style.color = '#666';
                    }, 3000);
                } else {
                    appendLog('âŒ leagues.csv íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    firebaseStatus.textContent = 'âŒ ì—°ê²° ì‹¤íŒ¨';
                    firebaseStatus.style.color = '#dc3545';
                }
            } catch (error) {
                appendLog(`âŒ CSV ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                const firebaseStatus = document.getElementById('firebaseStatus');
                firebaseStatus.textContent = 'âŒ ì—°ê²° ì‹¤íŒ¨';
                firebaseStatus.style.color = '#dc3545';
            }
        }

                  // Git ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
          async function loadGitInfo() {
              try {
                  const response = await fetch('/git-info');
                  const data = await response.json();
                  
                  if (data.success) {
                      document.getElementById('gitCommitHash').textContent = data.commit.shortHash;
                      document.getElementById('gitCommitDate').textContent = data.commit.date;
                      document.getElementById('gitCommitMessage').textContent = data.commit.message;
                      
                      // íˆ´í¬ìœ¼ë¡œ ì „ì²´ í•´ì‹œ í‘œì‹œ
                      document.getElementById('gitCommitHash').title = `ì „ì²´ í•´ì‹œ: ${data.commit.fullHash}`;
                      
                      console.log('âœ… Git ì •ë³´ ë¡œë“œ ì„±ê³µ:', data.commit);
                  } else {
                      document.getElementById('gitCommitHash').textContent = 'ì˜¤ë¥˜';
                      document.getElementById('gitCommitDate').textContent = 'ì •ë³´ ì—†ìŒ';
                      document.getElementById('gitCommitMessage').textContent = data.error || 'Git ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                      console.error('âŒ Git ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', data.error);
                  }
              } catch (error) {
                  document.getElementById('gitCommitHash').textContent = 'ì˜¤ë¥˜';
                  document.getElementById('gitCommitDate').textContent = 'ì—°ê²° ì‹¤íŒ¨';
                  document.getElementById('gitCommitMessage').textContent = 'ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                  console.error('âŒ Git ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
              }
          }

          // Git ì •ë³´ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì´ë²¤íŠ¸
          document.getElementById('refreshGitInfo').addEventListener('click', async () => {
              const refreshBtn = document.getElementById('refreshGitInfo');
              const originalText = refreshBtn.textContent;
              
              refreshBtn.textContent = 'â³ ë¡œë”©...';
              refreshBtn.disabled = true;
              
              await loadGitInfo();
              
              setTimeout(() => {
                  refreshBtn.textContent = originalText;
                  refreshBtn.disabled = false;
              }, 500);
          });

          // í˜ì´ì§€ ë¡œë“œ ì‹œ CSV ë°ì´í„°ì™€ Git ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
          window.addEventListener('load', () => {
              refreshCsvContent();
              loadGitInfo();
          });

        // CSV ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
        saveCsvBtn.addEventListener('click', async () => {
            try {
                saveCsvBtn.disabled = true;
                saveCsvBtn.textContent = 'Firebaseì— ì €ì¥ ì¤‘...';
                
                const firebaseStatus = document.getElementById('firebaseStatus');
                const csvSyncStatus = document.getElementById('csvSyncStatus');
                
                firebaseStatus.textContent = 'ğŸ”„ ì €ì¥ ì¤‘...';
                firebaseStatus.style.color = '#ffc107';
                
                const content = csvEditor.value;
                console.log('í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì „ì†¡í•  CSV ë‚´ìš© ê¸¸ì´:', content.length);
                console.log('CSV ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:', content.substring(0, 100));
                
                const response = await fetch('/leagues-csv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content })
                });

                if (response.ok) {
                    const responseText = await response.text();
                    appendLog('âœ… CSV íŒŒì¼ì´ Firebaseì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    console.log('ì„œë²„ ì‘ë‹µ:', responseText);
                    
                    // ì €ì¥ ì„±ê³µ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                    firebaseStatus.textContent = 'ğŸ”¥ Firebase ì—°ë™';
                    firebaseStatus.style.color = '#28a745';
                    saveCsvBtn.style.backgroundColor = '#28a745';
                    saveCsvBtn.textContent = 'Firebaseì— ì €ì¥ ì™„ë£Œ!';
                    saveCsvBtn.disabled = false; // ì¦‰ì‹œ ë²„íŠ¼ í™œì„±í™”
                    csvSyncStatus.textContent = 'âœ… Firebaseì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
                    csvSyncStatus.style.color = '#28a745';
                    
                    // 3ì´ˆ í›„ ê¸°ë³¸ ìƒíƒœë¡œ ë³µì›
                    setTimeout(() => {
                        saveCsvBtn.style.backgroundColor = '#6c757d';
                        saveCsvBtn.textContent = 'Firebaseì— ì €ì¥';
                        saveCsvBtn.disabled = false; // ë²„íŠ¼ í™œì„±í™” ë³´ì¥
                        csvSyncStatus.textContent = 'ğŸ’¡ ì´ì œ ì›¹ì—ì„œ ì§ì ‘ í¸ì§‘í•˜ê³  ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
                        csvSyncStatus.style.color = '#666';
                    }, 3000);
                } else {
                    const errorText = await response.text();
                    appendLog(`âŒ CSV íŒŒì¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorText}`);
                    console.error('ì„œë²„ ì˜¤ë¥˜:', errorText);
                    
                    firebaseStatus.textContent = 'âŒ ì €ì¥ ì‹¤íŒ¨';
                    firebaseStatus.style.color = '#dc3545';
                    
                    // ì˜¤ë¥˜ ì‹œì—ë„ ë²„íŠ¼ í™œì„±í™”
                    saveCsvBtn.disabled = false;
                    saveCsvBtn.textContent = 'Firebaseì— ì €ì¥';
                    saveCsvBtn.style.backgroundColor = '#6c757d';
                }
            } catch (error) {
                appendLog(`âŒ CSV ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                console.error('CSV ì €ì¥ ì˜¤ë¥˜:', error);
                
                const firebaseStatus = document.getElementById('firebaseStatus');
                firebaseStatus.textContent = 'âŒ ì €ì¥ ì‹¤íŒ¨';
                firebaseStatus.style.color = '#dc3545';
                
                // ì˜ˆì™¸ ë°œìƒ ì‹œì—ë„ ë²„íŠ¼ í™œì„±í™”
                saveCsvBtn.disabled = false;
                saveCsvBtn.textContent = 'Firebaseì— ì €ì¥';
                saveCsvBtn.style.backgroundColor = '#6c757d';
            } finally {
                // finally ë¸”ë¡ì—ì„œ í™•ì‹¤íˆ ë²„íŠ¼ í™œì„±í™”
                if (saveCsvBtn.textContent.includes('ì €ì¥ ì¤‘')) {
                    saveCsvBtn.disabled = false;
                    saveCsvBtn.textContent = 'Firebaseì— ì €ì¥';
                    saveCsvBtn.style.backgroundColor = '#6c757d';
                }
            }
        });

        function disableButtons() {
            crawlBtn.disabled = true;
            uploadBtn.disabled = true;
        }

        function enableButtons() {
            crawlBtn.disabled = false;
            uploadBtn.disabled = false;
            stopCrawlBtn.style.display = 'none';
            stopUploadBtn.style.display = 'none';
        }

        function showStopButton(type){
            if(type==='crawling') stopCrawlBtn.style.display='inline-block';
            if(type==='uploading') stopUploadBtn.style.display='inline-block';
        }

        function hideStopButton(type){
            if(type==='crawling') stopCrawlBtn.style.display='none';
            if(type==='uploading') stopUploadBtn.style.display='none';
        }

        function appendLog(message) {
            // ANSI ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤(ì»¬ëŸ¬ ì½”ë“œ)ë¥¼ ì œê±°í•˜ëŠ” ì •ê·œì‹
            const cleanMessage = message.replace(/[\u001b\u009b][[()#;?]*.?[0-9]{1,4}(?:;[0-9]{0,4})*.?[0-9A-ORZcf-nqry=><]/g, '');
            logContainer.innerHTML += cleanMessage.replace(/\n/g, '<br>');
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        socket.on('connect', () => {
            logContainer.innerHTML = 'âœ… ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.<br>';
        });

        socket.on('log', (message) => {
            if (message.includes('í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤')) {
                enableButtons();
            }
            appendLog(message);
        });

        // === í”„ë¡œì„¸ìŠ¤ ì‹œì‘/ì¢…ë£Œ ì´ë²¤íŠ¸ ===
        socket.on('process-started', (data) => {
            const { type } = data;
            showStopButton(type);
            disableButtons();
        });

        socket.on('process-ended', (data) => {
            const { type, options } = data;
            hideStopButton(type);
            enableButtons();

            const tsGen = () => { const n=new Date(); return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')} ${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; };

            if(options && options.league && options.year){
                const regionKey = options.region && options.region.trim()!=='' ? options.region : 'national';
                const key = `${options.league}_${regionKey}_${options.year}_${options.matchIdx || ''}`;
                const label = tsGen();
                if(type==='crawling') {
                    localStorage.setItem('crawl_'+key,label);
                    const cell=document.getElementById('crawl-'+key);
                    if(cell) cell.textContent=label;
                }
                if(type==='uploading') {
                    localStorage.setItem('upload_'+key,label);
                    const cell=document.getElementById('upload-'+key);
                    if(cell) cell.textContent=label;
                }
            }else if(options && !options.league){
                // ì „ì—­(ì›” ì „ì²´) ì‘ì—…ì¼ ê²½ìš°: ëª¨ë“  í–‰ì— ë™ì¼í•˜ê²Œ ê¸°ë¡
                const label = tsGen();
                document.querySelectorAll('#leagueTable tbody tr').forEach(row=>{
                    const key=row.querySelector('.select-league').dataset.key;
                    if(type==='crawling'){
                        localStorage.setItem('crawl_'+key,label);
                        row.querySelector('.crawl-time').textContent=label;
                    }
                    if(type==='uploading'){
                        localStorage.setItem('upload_'+key,label);
                        row.querySelector('.upload-time').textContent=label;
                    }
                });
            }
        });

        // ======================= ë¦¬ê·¸ í…Œì´ë¸” JS =======================
        function parseCsvToArray(csv) {
            const lines = csv.trim().split('\n');
            const result = [];
            if (lines.length < 2) return result;
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(',');
                if (cols.length < 5) continue; // ëˆ„ë½ ë°ì´í„° ë°©ì§€
                const [leagueTag, regionTag, year, leagueTitle, matchIdx] = cols;
                if (!leagueTag) continue;
                result.push({ leagueTag, regionTag, year, leagueTitle, matchIdx });
            }
            return result;
        }

        function renderLeagueTable(leagues) {
            const tableBody = document.querySelector('#leagueTable tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            // ì›” ì˜µì…˜ HTML ìºì‹œ
            const monthButtonsHtml = (() => {
                const btns = ['<button class="month-btn active" data-month="">ì „ì²´</button>'];
                for(let i=1;i<=12;i++){
                    const m = String(i).padStart(2,'0');
                    btns.push(`<button class="month-btn" data-month="${m}">${m}</button>`);
                }
                return btns.join('');
            })();

            leagues.forEach((l) => {
                const regionKey = l.regionTag && l.regionTag.trim()!=='' ? l.regionTag : 'national';
                const key = `${l.leagueTag}_${regionKey}_${l.year}_${l.matchIdx}`;
                const tr = document.createElement('tr');
                tr.dataset.matchidx = l.matchIdx;
                tr.dataset.leaguetitle = l.leagueTitle;
                const regionDisplay = l.regionTag && l.regionTag.trim() !== '' ? l.regionTag : 'ì „êµ­';
                tr.innerHTML = `
                    <td><input type="checkbox" class="select-league" data-key="${key}"></td>
                    <td>${l.leagueTag}</td>
                    <td>${regionDisplay}</td>
                    <td>${l.year}</td>
                    <td><div class="month-buttons">${monthButtonsHtml}</div></td>
                    <td style="text-align:left;">${l.leagueTitle}</td>
                    <td><button class="action-btn crawl-row-btn" data-key="${key}">í¬ë¡¤</button></td>
                    <td><button class="action-btn upload-row-btn" data-key="${key}">ì—…ë¡œë“œ</button></td>
                    <td class="crawl-time" id="crawl-${key}">${localStorage.getItem('crawl_'+key) || '-'}</td>
                    <td class="upload-time" id="upload-${key}">${localStorage.getItem('upload_'+key) || '-'}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // =========== ì „ì—­ ì›” ë²„íŠ¼ UI ìƒì„± ===========
        (function initGlobalMonthButtons(){
            const container = document.getElementById('globalMonthButtons');
            if(!container) return;
            const btnHtml = (()=>{
                const arr=['<button class="month-btn active" data-month="">ì „ì²´</button>'];
                for(let i=1;i<=12;i++){ const m=String(i).padStart(2,'0'); arr.push(`<button class="month-btn" data-month="${m}">${m}</button>`);} return arr.join('');
            })();
            container.innerHTML = btnHtml;
        })();

        // ì „ì—­ ì›” ë²„íŠ¼ í´ë¦­ â†’ ê° í–‰ ì›” ë²„íŠ¼ ë™ê¸°í™”
        document.getElementById('globalMonthControls')?.addEventListener('click',(e)=>{
            if(e.target.classList.contains('month-btn')){
                const btn=e.target;
                const wrapper=btn.parentElement;
                const isAll = btn.dataset.month==='';
                if(isAll){
                    // 'ì „ì²´' ì„ íƒ â†’ ë‚˜ë¨¸ì§€ í•´ì œ í›„ ë³¸ì¸ í™œì„±í™”
                    wrapper.querySelectorAll('.month-btn').forEach(b=>b.classList.remove('active'));
                    btn.classList.add('active');
                }else{
                    // ê°œë³„ ì›” í† ê¸€ ì„ íƒ
                    btn.classList.toggle('active');
                    // 'ì „ì²´' ë¹„í™œì„±í™”
                    wrapper.querySelector('.month-btn[data-month=""]')?.classList.remove('active');
                    // ì•„ë¬´ ê²ƒë„ ì„ íƒ ì•ˆ ë˜ì—ˆìœ¼ë©´ 'ì „ì²´' ë‹¤ì‹œ í™œì„±í™”
                    if(wrapper.querySelectorAll('.month-btn.active').length===0){
                        wrapper.querySelector('.month-btn[data-month=""]')?.classList.add('active');
                    }
                }

                // === í–‰ ë²„íŠ¼ ë™ê¸°í™” ===
                const activeMonthsArr = Array.from(wrapper.querySelectorAll('.month-btn.active')).map(b=>b.dataset.month);
                document.querySelectorAll('#leagueTable tbody .month-buttons').forEach(w=>{
                    w.querySelectorAll('.month-btn').forEach(b=>{
                        if(activeMonthsArr.includes('')){
                            // ì „ì²´ ì„ íƒ: í–‰ë„ ì „ì²´ë§Œ í™œì„±
                            b.classList.toggle('active', b.dataset.month==='');
                        }else{
                            b.classList.toggle('active', activeMonthsArr.includes(b.dataset.month));
                        }
                    });
                });
            }
        });

        // ===== ì „ì—­ ì›” ì „ì²´ í¬ë¡¤ë§/ì—…ë¡œë“œ ë²„íŠ¼ =====
        document.getElementById('crawlMonthAllBtn')?.addEventListener('click',()=>{
            const monthEls = document.querySelectorAll('#globalMonthButtons .month-btn.active');
            const monthsArr = Array.from(monthEls).map(b=>b.dataset.month).filter(m=>m!=='');
            const monthParam = monthsArr.join(',');
            const firstRow = document.querySelector('#leagueTable tbody tr');
            if(!firstRow){ alert('í…Œì´ë¸”ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'); return; }
            const year = firstRow.children[3]?.textContent.trim() || '';
            disableButtons();
            appendLog(`ğŸš€ ëª¨ë“  ë¦¬ê·¸ ${monthParam||'ì „ì²´'}ì›” í¬ë¡¤ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤...`);
            // ë‹¨ì¼ ìš”ì²­ìœ¼ë¡œ ëª¨ë“  ë¦¬ê·¸ ì²˜ë¦¬ â€“ ì„œë²„/ìŠ¤í¬ë¦½íŠ¸ì—ì„œ month, yearë§Œ í•„í„°ë§
            socket.emit('start-crawl',{ year, month: monthParam });
        });

        document.getElementById('uploadMonthAllBtn')?.addEventListener('click',()=>{
            const monthEls2 = document.querySelectorAll('#globalMonthButtons .month-btn.active');
            const monthsArr2 = Array.from(monthEls2).map(b=>b.dataset.month).filter(m=>m!=='');
            const monthParam2 = monthsArr2.join(',');
            const firstRow = document.querySelector('#leagueTable tbody tr');
            if(!firstRow){ alert('í…Œì´ë¸”ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'); return; }
            const year = firstRow.children[3]?.textContent.trim() || '';
            disableButtons();
            appendLog(`â˜ï¸ ëª¨ë“  ë¦¬ê·¸ ${monthParam2||'ì „ì²´'}ì›” ì—…ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...`);
            // ì—…ë¡œë“œë„ ë‹¨ì¼ ìš”ì²­ìœ¼ë¡œ ì²˜ë¦¬
            socket.emit('start-upload',{ year, month: monthParam2 });
        });

        // === ì„ íƒ ì‘ì—… ë²„íŠ¼ ===
        document.getElementById('selectAllLeagues').addEventListener('change', (e)=>{
            document.querySelectorAll('.select-league').forEach(cb=>{ cb.checked = e.target.checked; });
        });

        document.getElementById('crawlSelectedBtn').addEventListener('click', ()=>{
            const keys = Array.from(document.querySelectorAll('.select-league:checked')).map(cb=>cb.dataset.key);
            if(keys.length===0){ alert('ë¦¬ê·¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
            disableButtons();
            appendLog(`ğŸš€ ì„ íƒëœ ${keys.length}ê°œ ë¦¬ê·¸ í¬ë¡¤ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤...`);
            keys.forEach(k=>{ 
                const row = document.querySelector(`.select-league[data-key="${k}"]`).closest('tr');
                const months = Array.from(row.querySelectorAll('.month-btn.active')).map(b=>b.dataset.month).filter(m=>m!=='');
                const month = months.join(',');
                const [tag, region, year, matchIdx] = k.split('_'); 
                const leagueTitle = row.dataset.leaguetitle;
                socket.emit('start-crawl', { year, month: month, league: tag, region: region, matchIdx: matchIdx, leagueTitle }); 
            });
        });

        document.getElementById('uploadSelectedBtn').addEventListener('click', ()=>{
            const keys = Array.from(document.querySelectorAll('.select-league:checked')).map(cb=>cb.dataset.key);
            if(keys.length===0){ alert('ë¦¬ê·¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
            disableButtons();
            appendLog(`â˜ï¸ ì„ íƒëœ ${keys.length}ê°œ ë¦¬ê·¸ ì—…ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...`);
            keys.forEach(k=>{ 
                const row = document.querySelector(`.select-league[data-key="${k}"]`).closest('tr');
                const months = Array.from(row.querySelectorAll('.month-btn.active')).map(b=>b.dataset.month).filter(m=>m!=='');
                const month = months.join(',');
                const [tag, region, year, matchIdx] = k.split('_'); 
                const leagueTitle = row.dataset.leaguetitle;
                socket.emit('start-upload', { year, month: month, league: tag, region: region, matchIdx: matchIdx, leagueTitle }); 
            });
        });

        // === í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ===
        document.getElementById('refreshTableBtn').addEventListener('click', () => {
            if (csvEditor.value) {
                renderAndStoreLeagues(csvEditor.value);
                appendLog('ğŸ”„ í…Œì´ë¸” í‘œì‹œê°€ ìƒˆë¡œê³ ì¹¨ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        });

        // === ì‘ì—… í ìƒíƒœ ì—…ë°ì´íŠ¸ ===
        socket.on('queue-status', (status) => {
            const { runningCrawl, runningUpload, waitingCrawl, waitingUpload } = status;
            const runningJobEl = document.getElementById('runningJob');
            const waitingJobsEl = document.getElementById('waitingJobs');

            if (runningCrawl || runningUpload) {
                const obj = runningCrawl || runningUpload;
                const year = obj.year || 'ì „ì²´';
                const league = obj.league || 'ì „ì²´';
                runningJobEl.textContent = `${league} (${year})`;
            } else {
                runningJobEl.textContent = 'ì—†ìŒ';
            }

            const waitingArray = [...(waitingCrawl||[]), ...(waitingUpload||[])];
            if (waitingArray.length > 0) {
                const waitingText = waitingArray.map(j => `${j.league || 'ì „ì²´'}(${j.year || 'ì „ì²´'})`).join(', ');
                waitingJobsEl.textContent = `${waitingArray.length}ê°œ ëŒ€ê¸°ì¤‘: ${waitingText}`;
            } else {
                waitingJobsEl.textContent = 'ì—†ìŒ';
            }
        });

        // === ë¡œê·¸ ì§€ìš°ê¸° ===
        document.getElementById('clearLogBtn').addEventListener('click', ()=>{ logContainer.innerHTML=''; });

        // ================= ë¡œê·¸ì¸ ê¸°ëŠ¥ =================
        (function initLogin(){
            const overlay = document.getElementById('loginOverlay');
            const dashboard = document.getElementById('dashboardWrapper');
            const stored = localStorage.getItem('loggedIn');
            if(stored==='true'){
                overlay.style.display='none';
                dashboard.style.display='block';
            }else{
                overlay.style.display='flex';
            }
            document.getElementById('loginBtn').addEventListener('click', ()=>{
                const u=document.getElementById('loginUser').value.trim();
                const p=document.getElementById('loginPass').value.trim();
                const err=document.getElementById('loginError');
                if(u==='essaisko' && p==='60687452'){
                    if(document.getElementById('rememberMe').checked){ localStorage.setItem('loggedIn','true'); }
                    overlay.style.display='none';
                    dashboard.style.display='block';
                }else{
                    err.textContent='ë¡œê·¸ì¸ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                }
            });
        })();

        // ë¡œê·¸ì•„ì›ƒ
        document.getElementById('logoutBtn').addEventListener('click',()=>{
            localStorage.removeItem('loggedIn');
            location.reload();
              });

        // === í…Œì´ë¸” ë‚´ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬ (ì´ë²¤íŠ¸ ìœ„ì„)
        document.addEventListener('click', (e) => {
            // ì›” ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
            if(e.target.classList.contains('month-btn')){
                // ì „ì—­ ì»¨íŠ¸ë¡¤ ì˜ì—­ì¸ì§€ í™•ì¸
                if(e.target.closest('#globalMonthControls')){
                    // ì „ì—­ ì»¨íŠ¸ë¡¤ì€ ë³„ë„ ë¡œì§ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë¬´ì‹œ
                    return;
                }

                // í–‰ ë‚´ë¶€ ì›” ë²„íŠ¼: ë‹¨ì¼ ì„ íƒ ìœ ì§€ (ê¸°ì¡´ ë¡œì§)
                const wrapper = e.target.parentElement;
                wrapper.querySelectorAll('.month-btn').forEach(b=>b.classList.remove('active'));
                e.target.classList.add('active');
                return; // ë‹¤ë¥¸ í•¸ë“¤ëŸ¬ ì‹¤í–‰ ì•ˆí•˜ë„ë¡
            }
            if (e.target.classList.contains('crawl-row-btn')) {
                const key = e.target.dataset.key;
                const [leagueTag, regionTag, year, matchIdx] = key.split('_');
                const months = Array.from(e.target.closest('tr').querySelectorAll('.month-btn.active')).map(b=>b.dataset.month).filter(m=>m!=='');
                const month = months.join(',');
                disableButtons();
                appendLog(`ğŸš€ [${leagueTag} ${year} ${month||'ì „ì²´'}ì›”] ê°œë³„ í¬ë¡¤ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤...`);
                const leagueTitle = e.target.closest('tr').dataset.leaguetitle;
                socket.emit('start-crawl', { year, month: month, league: leagueTag, region: regionTag, matchIdx: matchIdx, leagueTitle });
                e.target.disabled = true;
            }
            if (e.target.classList.contains('upload-row-btn')) {
                const key = e.target.dataset.key;
                const [leagueTag, regionTag, year, matchIdx] = key.split('_');
                const months = Array.from(e.target.closest('tr').querySelectorAll('.month-btn.active')).map(b=>b.dataset.month).filter(m=>m!=='');
                const month = months.join(',');
                disableButtons();
                appendLog(`â˜ï¸ [${leagueTag} ${year} ${month||'ì „ì²´'}ì›”] ê°œë³„ ì—…ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...`);
                const leagueTitle = e.target.closest('tr').dataset.leaguetitle;
                socket.emit('start-upload', { year, month: month, league: leagueTag, region: regionTag, matchIdx: matchIdx, leagueTitle });
                e.target.disabled = true;
            }
        });

        // === STOP ë²„íŠ¼ ë™ì‘ ===
        stopCrawlBtn.addEventListener('click', () => {
            const crawling = Array.from(currentProcesses.entries()).find(([pid, info]) => info.type === 'crawling');
            if(crawling){
                const [processId] = crawling;
                socket.emit('stop-process', { processId });
                stopCrawlBtn.disabled = true;
            }
        });

         stopUploadBtn.addEventListener('click', () => {
            const uploading = Array.from(currentProcesses.entries()).find(([pid, info]) => info.type === 'uploading');
            if(uploading){
                const [processId] = uploading;
                 socket.emit('stop-process', { processId });
                 stopUploadBtn.disabled = true;
             }
         });
    </script>
</body>
</html> 